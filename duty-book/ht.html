<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<title>HT Dashboard · Head Teacher</title>

<!-- Font Awesome 6 (free) for icons & brand -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<!-- jsPDF + html2canvas for PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  /* ---------- GLOBAL & VARIABLES ---------- */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  }

  body {
    background: linear-gradient(145deg, #f0f4fa 0%, #e9eef4 100%);
    min-height: 100vh;
    padding: clamp(1rem, 5vw, 2rem);
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    line-height: 1.5;
  }

  /* ---------- DECORATIVE RADIAL CIRCLES (fixed) ---------- */
  .bg-circle-1, .bg-circle-2 {
    position: fixed;
    width: 280px;
    height: 280px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(0,112,243,0.08) 0%, transparent 80%);
    pointer-events: none;
    z-index: 0;
  }
  .bg-circle-1 {
    top: 2%;
    left: 2%;
    width: clamp(200px, 30vw, 280px);
    height: clamp(200px, 30vw, 280px);
    background: radial-gradient(circle, rgba(0,112,243,0.08) 0%, transparent 75%);
  }
  .bg-circle-2 {
    bottom: 5%;
    right: 2%;
    width: clamp(240px, 35vw, 340px);
    height: clamp(240px, 35vw, 340px);
    background: radial-gradient(circle, rgba(0,180,210,0.07) 0%, transparent 80%);
  }

  /* ---------- MAIN CONTAINER (above circles) ---------- */
  .dashboard-container {
    max-width: 1400px;
    width: 100%;
    position: relative;
    z-index: 10;
    animation: fadeSlide 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  }

  /* ---------- GLASS CARD (reusable) ---------- */
  .glass-card {
    background: rgba(255,255,255,0.8);
    backdrop-filter: blur(16px) saturate(180%);
    -webkit-backdrop-filter: blur(16px) saturate(180%);
    border-radius: clamp(24px, 5vw, 32px);
    box-shadow: 0 20px 35px -10px rgba(0,20,40,0.15);
    border: 1px solid rgba(255,255,255,0.3);
    box-shadow: 0 0 0 1px rgba(255,255,255,0.5) inset, 0 20px 35px -10px rgba(0,20,40,0.15);
    padding: clamp(1.2rem, 4vw, 2rem);
    transition: box-shadow 0.25s ease, background 0.25s;
    margin-bottom: 1.8rem;
  }

  /* ---------- FLUID TYPOGRAPHY / CLAMP ---------- */
  body, input, select, button, td, th, li, .badge, .info-note, h2, h3, h4, textarea, p {
    font-size: clamp(0.8rem, 2vw, 0.95rem);
  }

  h2 {
    font-size: clamp(1.3rem, 4vw, 1.6rem);
    font-weight: 600;
    color: #0b2b4e;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  h3 {
    font-size: clamp(1.1rem, 3.5vw, 1.3rem);
    font-weight: 600;
    color: #1e4c6b;
    margin-bottom: 1.2rem;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  h4 {
    font-size: clamp(1rem, 3vw, 1.1rem);
    font-weight: 600;
    color: #0a4e7a;
    margin: 1rem 0 0.5rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .section-icon {
    font-size: clamp(1.4rem, 4vw, 1.6rem);
    color: #0a66c2;
    background: rgba(10,102,194,0.08);
    padding: 0.6rem;
    border-radius: 18px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  /* ---------- HEADER CARD (brand + role) ---------- */
  .header-card {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 2rem;
  }
  .brand {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .brand i {
    font-size: clamp(1.6rem, 5vw, 2rem);
    color: #0a66c2;
    filter: drop-shadow(0 4px 6px rgba(0,102,204,0.2));
  }
  .brand-text {
    background: linear-gradient(150deg, #0b2b4e, #1e4c6b);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    font-weight: 700;
    font-size: clamp(1.4rem, 5vw, 1.9rem);
    letter-spacing: -0.01em;
  }
  .role-badge {
    background: rgba(10,102,194,0.15);
    border-radius: 40px;
    color: #0a4e7a;
    padding: 0.5rem 1.5rem;
    font-weight: 600;
    font-size: 0.95rem;
    border: 1px solid rgba(255,255,255,0.3);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* ---------- BUTTON VARIANTS ---------- */
  button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.6rem;
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 40px;
    padding: 0.7rem 1.5rem;
    font-weight: 600;
    font-size: clamp(0.8rem, 2vw, 0.95rem);
    transition: all 0.2s;
    cursor: pointer;
    margin: 0.25rem;
    background: transparent;
    color: inherit;
    white-space: nowrap;
  }
  button i {
    font-size: 0.95rem;
  }
  .btn-primary {
    background: #0a66c2;
    color: white;
    box-shadow: 0 8px 16px -6px rgba(10,102,194,0.25);
  }
  .btn-primary:hover {
    background: #004a8f;
    scale: 1.02;
  }
  .btn-success {
    background: #10b981;
    color: white;
  }
  .btn-success:hover {
    background: #059669;
    scale: 1.02;
  }
  .btn-danger {
    background: #ef4444;
    color: white;
  }
  .btn-danger:hover {
    background: #dc2626;
    scale: 1.02;
  }
  .btn-outline {
    background: transparent;
    border: 1.5px solid #0a66c2;
    color: #0a66c2;
  }
  .btn-outline:hover {
    background: #0a66c2;
    color: white;
    scale: 1.02;
  }
  .btn-warning {
    background: #f59e0b;
    color: white;
  }
  .btn-warning:hover {
    background: #d97706;
    scale: 1.02;
  }
  .btn-info {
    background: #8e44ad;
    color: white;
  }
  .btn-info:hover {
    background: #71368a;
    scale: 1.02;
  }
  .btn-small {
    padding: 0.4rem 1rem;
    font-size: 0.8rem;
  }
  @media (max-width: 768px) {
    button { width: 100%; justify-content: center; }
  }

  /* ---------- NAVIGATION BUTTONS ---------- */
  .nav-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .nav-btn {
    background: rgba(255,255,255,0.7);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(10,102,194,0.2);
    color: #0a4e7a;
    font-weight: 600;
    padding: 0.8rem 2rem;
    border-radius: 40px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .nav-btn:hover {
    background: white;
    border-color: #0a66c2;
    color: #0a66c2;
  }
  .nav-btn.active {
    background: #0a66c2;
    color: white;
    border-color: #0a66c2;
  }

  /* ---------- TABLE STYLES ---------- */
  .table-responsive {
    overflow-x: auto;
    margin-top: 1.5rem;
    border-radius: 20px;
    width: 100%;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: rgba(255,255,255,0.4);
    backdrop-filter: blur(4px);
    border-radius: 20px;
    border-style: hidden;
    box-shadow: 0 0 0 1px rgba(10,102,194,0.1);
    margin-bottom: 1rem;
  }
  th {
    background: #0a66c2;
    color: white;
    padding: 0.9rem 0.5rem;
    font-weight: 600;
    text-align: center;
    font-size: 0.85rem;
    letter-spacing: 0.3px;
  }
  th:first-child { border-radius: 16px 0 0 0; }
  th:last-child { border-radius: 0 16px 0 0; }
  td {
    padding: 0.8rem 0.5rem;
    border-bottom: 1px solid rgba(10,102,194,0.1);
    background: transparent;
    text-align: center;
    vertical-align: middle;
  }
  tbody tr:hover {
    background: rgba(10,102,194,0.02);
  }
  .totalRow {
    background: rgba(10,102,194,0.08);
    font-weight: 700;
  }

  /* ---------- FORM INPUTS WITH ICONS ---------- */
  .input-icon-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    width: 100%;
  }
  .input-icon-wrapper i {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: #6b8ca3;
    font-size: 1rem;
    z-index: 2;
  }
  .input-icon-wrapper select,
  .input-icon-wrapper textarea {
    width: 100%;
    padding: 0.85rem 1rem 0.85rem 2.8rem;
    background: rgba(255,255,255,0.8);
    border: 1.5px solid rgba(200,215,225,0.7);
    border-radius: 20px;
    font-size: clamp(0.8rem, 2vw, 0.95rem);
    transition: all 0.2s;
    outline: none;
    color: #1e2f3e;
    appearance: none;
  }
  .input-icon-wrapper textarea {
    padding: 1rem 1rem 1rem 2.8rem;
    resize: vertical;
    min-height: 120px;
    line-height: 1.6;
  }
  .input-icon-wrapper select {
    background: rgba(255,255,255,0.8) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b8ca3' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E") no-repeat;
    background-position: right 1rem center;
    background-size: 16px;
    padding-right: 2.5rem;
  }
  .input-icon-wrapper select:focus,
  .input-icon-wrapper textarea:focus {
    border-color: #0a66c2;
    background: white;
    box-shadow: 0 6px 14px rgba(10,102,194,0.08);
  }

  /* ---------- ANSWER CARD ---------- */
  .answer-card {
    background: rgba(224,242,254,0.7);
    backdrop-filter: blur(8px);
    border-radius: 24px;
    padding: 1.5rem;
    border-left: 6px solid #0a66c2;
    margin: 1.5rem 0;
    font-size: 1rem;
    line-height: 1.6;
    color: #0a4e7a;
    box-shadow: 0 8px 20px -8px rgba(0,0,0,0.1);
  }

  /* ---------- DUTY PLAN SECTION (WEEK-BASED) ---------- */
  .duty-card {
    background: rgba(255,255,255,0.7);
    backdrop-filter: blur(8px);
    border-radius: 24px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid rgba(10,102,194,0.2);
  }
  .week-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: rgba(255,255,255,0.5);
    border-radius: 16px;
    border: 1px solid rgba(10,102,194,0.1);
  }
  .week-number {
    font-weight: 700;
    color: #0a66c2;
    min-width: 80px;
    font-size: 1.1rem;
    background: rgba(10,102,194,0.1);
    padding: 0.5rem 1rem;
    border-radius: 30px;
    text-align: center;
  }
  .week-dates {
    font-size: 0.95rem;
    color: #2c5a73;
    min-width: 300px;
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
  }
  .date-row {
    display: flex;
    align-items: center;
    gap: 0.8rem;
  }
  .date-label {
    font-weight: 600;
    color: #0a4e7a;
    width: 50px;
  }
  .date-value {
    font-family: monospace;
    background: white;
    padding: 0.2rem 0.8rem;
    border-radius: 20px;
  }
  
  /* Active week indicator */
  .current-week {
    background: rgba(16,185,129,0.1);
    border: 2px solid #10b981;
  }

  /* ---------- RECORD LIST ---------- */
  .record-item {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    padding: 0.8rem 1.2rem;
    margin-bottom: 0.8rem;
    background: rgba(255,255,255,0.7);
    backdrop-filter: blur(8px);
    border-radius: 20px;
    border: 1px solid rgba(10,102,194,0.2);
    transition: all 0.2s;
  }
  .record-item:hover {
    background: white;
    border-color: rgba(10,102,194,0.4);
    box-shadow: 0 4px 12px rgba(0,0,0,0.02);
  }
  .record-date {
    font-weight: 600;
    color: #1e4c6b;
  }
  .record-badge {
    background: rgba(10,102,194,0.1);
    border-radius: 30px;
    padding: 0.2rem 1rem;
    font-size: 0.8rem;
    color: #0a4e7a;
  }

  /* ---------- WEEK GROUP ---------- */
  .week-group {
    margin-bottom: 2rem;
    border-radius: 20px;
    overflow: hidden;
  }
  .week-header {
    background: rgba(142,68,173,0.15);
    color: #71368a;
    padding: 0.8rem 1.5rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.8rem;
    border-left: 6px solid #8e44ad;
    margin-bottom: 0.5rem;
    border-radius: 16px 16px 0 0;
  }
  .week-days {
    padding-left: 1.5rem;
  }

  /* ---------- BADGES & INFO ---------- */
  .badge {
    background: rgba(10,102,194,0.1);
    border-radius: 30px;
    padding: 0.3rem 1rem;
    font-size: 0.8rem;
    color: #0a4e7a;
    display: inline-block;
    border: 1px solid rgba(255,255,255,0.2);
  }
  .info-note {
    background: rgba(10,102,194,0.04);
    border-radius: 16px;
    padding: 1rem;
    border: 1px dashed rgba(10,102,194,0.2);
    display: flex;
    align-items: center;
    gap: 0.8rem;
    color: #2c5a73;
    margin: 1.2rem 0;
  }
  .empty-state {
    text-align: center;
    padding: 3rem;
    color: #6b8ca3;
    background: rgba(255,255,255,0.5);
    border-radius: 24px;
    font-style: italic;
    backdrop-filter: blur(6px);
    border: 1px solid rgba(255,255,255,0.2);
  }

  /* ---------- ANIMATIONS ---------- */
  @keyframes fadeSlide {
    0% { opacity: 0; transform: translateY(12px); }
    100% { opacity: 1; transform: translateY(0); }
  }

  hr {
    margin: 2rem 0;
    border: none;
    border-top: 1px solid rgba(10,102,194,0.2);
  }

  /* ---------- LOGOUT BUTTON ---------- */
  #logoutBtn i, #logoutBtnBottom i {
    transition: transform 0.2s;
  }
  #logoutBtn:hover i, #logoutBtnBottom:hover i {
    transform: translateX(3px);
  }

  /* ---------- CONTENT AREA ---------- */
  #content {
    margin-top: 1.5rem;
  }

  /* ---------- PDF CONTENT ---------- */
  .pdf-content {
    background: white;
    padding: 2rem;
    border-radius: 16px;
  }

  /* ---------- WEEK NUMBER BADGE ---------- */
  .week-badge {
    background: rgba(142,68,173,0.1);
    color: #71368a;
    padding: 0.2rem 1rem;
    border-radius: 30px;
    font-size: 0.8rem;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
  }

  /* ---------- YEAR SELECTOR ---------- */
  .year-selector {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }
  .year-btn {
    background: rgba(255,255,255,0.7);
    border: 1px solid rgba(10,102,194,0.2);
    color: #0a4e7a;
    padding: 0.5rem 1.2rem;
    border-radius: 40px;
    font-weight: 600;
  }
  .year-btn.active {
    background: #0a66c2;
    color: white;
    border-color: #0a66c2;
  }
  
  /* ---------- PDF REPORT STYLES ---------- */
  .pdf-report {
    font-family: 'Inter', sans-serif;
    background: white;
    padding: 30px;
    max-width: 1000px;
    margin: 0 auto;
  }
  .pdf-report h1 {
    font-size: 24px;
    color: #0b2b4e;
    margin-bottom: 10px;
    border-bottom: 2px solid #0a66c2;
    padding-bottom: 10px;
  }
  .pdf-report .subtitle {
    font-size: 16px;
    color: #1e4c6b;
    margin-bottom: 5px;
  }
  .pdf-report .tod-info {
    font-size: 14px;
    color: #0a4e7a;
    margin-bottom: 20px;
    padding: 10px;
    background: #e6f7ff;
    border-radius: 8px;
  }
  .pdf-report table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    font-size: 12px;
  }
  .pdf-report th {
    background: #0a66c2;
    color: white;
    padding: 10px 5px;
    text-align: center;
  }
  .pdf-report td {
    border: 1px solid #ddd;
    padding: 8px 5px;
    text-align: center;
  }
  .pdf-report .grand-total {
    background: #e6f7ff;
    font-weight: bold;
  }
  .pdf-report .summary {
    margin-top: 20px;
    padding: 15px;
    background: #f9f9f9;
    border-left: 6px solid #0a66c2;
    font-size: 14px;
  }
  
  /* PDF Container - Hidden but used for generation */
  .pdf-container {
    position: absolute;
    left: -9999px;
    top: 0;
    width: 1000px;
    background: white;
  }
</style>
</head>

<body>
<!-- Decorative background circles -->
<div class="bg-circle-1"></div>
<div class="bg-circle-2"></div>

<div class="dashboard-container">
  <!-- HEADER CARD (brand + role) -->
  <div class="glass-card header-card">
    <div class="brand">
      <i class="fas fa-user-tie"></i>
      <span class="brand-text">HT Dashboard</span>
    </div>
    <div class="role-badge">
      <i class="fas fa-user-shield"></i> Head Teacher
      <span class="badge" style="margin-left: 0.5rem;" id="headerEmail"></span>
    </div>
  </div>

  <!-- LOGOUT BUTTON - TOP -->
  <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
    <button id="logoutBtn" class="btn-outline" style="border-width: 1.5px; padding: 0.7rem 2.2rem; border-color: #ef4444; color: #ef4444;">
      <i class="fas fa-sign-out-alt"></i> Logout
    </button>
  </div>

  <!-- MAIN CONTENT CARD -->
  <div class="glass-card">
    <!-- NAVIGATION BUTTONS -->
    <div class="nav-buttons">
      <button id="navUsers" class="nav-btn" onclick="showUsers()">
        <i class="fas fa-users"></i> Users
      </button>
      <button id="navToday" class="nav-btn" onclick="showToday()">
        <i class="fas fa-calendar-day"></i> Today
      </button>
      <button id="navDutyHistory" class="nav-btn" onclick="showDutyHistory()">
        <i class="fas fa-history"></i> Duty History
      </button>
      <button id="navPlanDuty" class="nav-btn" onclick="showPlanDuty()">
        <i class="fas fa-calendar-plus"></i> Plan Duty
      </button>
    </div>

    <hr>

    <!-- CONTENT AREA -->
    <div id="content"></div>
  </div>

  <!-- LOGOUT BUTTON - BOTTOM -->
  <div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
    <button id="logoutBtnBottom" class="btn-outline" style="border-width: 1.5px; padding: 0.7rem 2.2rem; border-color: #ef4444; color: #ef4444;">
      <i class="fas fa-sign-out-alt"></i> Logout
    </button>
  </div>
</div>

<!-- Hidden PDF Container - Used for generating clean PDFs -->
<div id="pdfReportContainer" class="pdf-container"></div>

<script type="module">
/* ================= FIREBASE ================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
  getFirestore, collection, getDocs, doc, getDoc, 
  setDoc, updateDoc, query, where 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// ========== FIREBASE CONFIG ==========
const firebaseConfig = {
  apiKey: "AIzaSyBYOXnAQQWQNI9rFu0ZwMjNkMEdJH7SxxA",
  authDomain: "teacher-on-duty-system.firebaseapp.com",
  projectId: "teacher-on-duty-system",
  storageBucket: "teacher-on-duty-system.firebasestorage.app",
  messagingSenderId: "723640168531",
  appId: "1:723640168531:web:a52f5dac1f5502460016a6"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ================= HELPER FUNCTIONS ================= */

function getTodayISO() {
  return new Date().toISOString().split("T")[0];
}

function getWeekNumber(date) {
  const firstDay = new Date(date.getFullYear(), 0, 1);
  const pastDays = (date - firstDay) / 86400000;
  return Math.ceil((pastDays + firstDay.getDay() + 1) / 7);
}

function getCurrentWeekNumber() {
  return getWeekNumber(new Date());
}

function getMondayDate(weekNum, year) {
  // Get first day of year
  const firstDay = new Date(year, 0, 1);
  // Get day of week (0 = Sunday, 1 = Monday, etc.)
  const dayOfWeek = firstDay.getDay();
  
  // Calculate days to add to get to the Monday of the target week
  // Week 1 starts on the first Monday of the year
  let daysToAdd;
  if (dayOfWeek === 0) { // Sunday
    daysToAdd = 1; // First Monday is Jan 2
  } else if (dayOfWeek === 1) { // Monday
    daysToAdd = 0; // First Monday is Jan 1
  } else { // Tuesday to Saturday
    daysToAdd = 8 - dayOfWeek; // Days until next Monday
  }
  
  // Calculate Monday of week 1
  const firstMonday = new Date(year, 0, 1 + daysToAdd);
  
  // Calculate Monday of target week
  const targetMonday = new Date(firstMonday);
  targetMonday.setDate(firstMonday.getDate() + (weekNum - 1) * 7);
  
  return targetMonday;
}

function getWeekDates(weekNum, year) {
  const monday = getMondayDate(weekNum, year);
  const days = [];
  
  for (let i = 0; i < 5; i++) {
    const date = new Date(monday);
    date.setDate(monday.getDate() + i);
    days.push({
      name: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'][i],
      date: date
    });
  }
  
  return days;
}

function formatDate(date) {
  return date.toLocaleDateString('en-GB', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric'
  }).replace(/\//g, '/');
}

function getYear(date) {
  return date.getFullYear();
}

function formatDateLong(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { 
    weekday: 'short', 
    year: 'numeric', 
    month: 'short', 
    day: 'numeric' 
  });
}

function generateTableFromData(dataArray) {
  if (!dataArray || dataArray.length === 0) {
    return `<p>No attendance data available</p>`;
  }
  
  let html = `<div class="table-responsive"><table>
    <thead>
      <tr>
        <th>Class</th>
        <th>Reg B</th>
        <th>Reg G</th>
        <th>Pre B</th>
        <th>Pre G</th>
        <th>Abs B</th>
        <th>Abs G</th>
        <th>Sick B</th>
        <th>Sick G</th>
        <th>Perm B</th>
        <th>Perm G</th>
        <th>Total Pre</th>
      </tr>
    </thead>
    <tbody>`;
  
  let totalReg = 0, totalPre = 0;
  
  dataArray.forEach(item => {
    let preTotal = (parseInt(item.preB) || 0) + (parseInt(item.preG) || 0);
    let regTotal = (parseInt(item.regB) || 0) + (parseInt(item.regG) || 0);
    totalReg += regTotal;
    totalPre += preTotal;
    
    html += `<tr>
      <td><strong>${item.class}</strong></td>
      <td>${item.regB || 0}</td>
      <td>${item.regG || 0}</td>
      <td>${item.preB || 0}</td>
      <td>${item.preG || 0}</td>
      <td>${item.absB || 0}</td>
      <td>${item.absG || 0}</td>
      <td>${item.sickB || 0}</td>
      <td>${item.sickG || 0}</td>
      <td>${item.perB || 0}</td>
      <td>${item.perG || 0}</td>
      <td><strong>${preTotal}</strong></td>
    </tr>`;
  });
  
  let percentage = totalReg > 0 ? Math.round((totalPre / totalReg) * 100) : 0;
  
  html += `<tr class="totalRow">
    <td><strong>GRAND TOTAL</strong></td>
    <td colspan="11" style="text-align: left; padding-left: 1rem;">
      <strong>Total Students: ${totalReg} | Present: ${totalPre} (${percentage}%)</strong>
    </td>
  </tr></tbody></table></div>`;
  
  return html;
}

/* ================= AUTH CHECK ================= */

onAuthStateChanged(auth, async(user)=>{
  if(!user){
    alert("Not logged in");
    window.location = "index.html";
  } else {
    // Display user email in header
    document.getElementById("headerEmail").innerText = user.email;
    
    // Check if user has HT role
    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (userDoc.exists() && userDoc.data().role === "HT") {
      // Show HT dashboard
      showToday(); // Default view
    } else {
      alert("Access Denied: Head Teacher only");
      window.location = "index.html";
    }
  }
});

/* ================= LOGOUT FUNCTION ================= */

window.logout = async function() {
  try {
    await signOut(auth);
    alert("✅ Logged out successfully");
    window.location = "index.html";
  } catch (error) {
    alert("Error logging out: " + error.message);
  }
};

/* ================= USERS ================= */

window.showUsers = async function(){
  // Set active nav button
  document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById('navUsers').classList.add('active');

  let html = `
    <h3><i class="fas fa-users" style="color: #0a66c2; margin-right: 0.5rem;"></i> All Users</h3>
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
          </tr>
        </thead>
        <tbody>
  `;

  const snapshot = await getDocs(collection(db, "users"));

  snapshot.forEach(docSnap => {
    let u = docSnap.data();
    let roleColor = u.role === "IT" ? "#0a66c2" : 
                    u.role === "HT" ? "#10b981" : 
                    u.role === "TOD" ? "#f59e0b" : "#6b8ca3";
    
    html += `<tr>
      <td><strong>${u.name || '-'}</strong></td>
      <td>${u.email || '-'}</td>
      <td><span style="color: ${roleColor}; font-weight: 600;">${u.role || '-'}</span></td>
    </tr>`;
  });

  html += `</tbody></table></div>`;
  html += `<div class="info-note" style="margin-top: 1rem;">
    <i class="fas fa-info-circle"></i> Total Users: ${snapshot.size}
  </div>`;

  document.getElementById("content").innerHTML = html;
}

/* ================= SHOW TODAY ================= */

window.showToday = async function() {
  // Set active nav button
  document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById('navToday').classList.add('active');

  const todayISO = getTodayISO();
  const docSnap = await getDoc(doc(db, "attendance", todayISO));

  if (!docSnap.exists()) {
    document.getElementById("content").innerHTML = `
      <div class="empty-state">
        <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
        <h3 style="color: #6b8ca3; margin-bottom: 0.5rem;">No Report Submitted</h3>
        <p>No attendance report has been submitted for today.</p>
      </div>
    `;
    return;
  }

  const data = docSnap.data();
  
  // Generate table HTML from data
  let tableHTML = data.data ? generateTableFromData(data.data) : (data.tableHTML || "<p>No attendance data available</p>");

  document.getElementById("content").innerHTML = `
  <div id="todayReportContainer" class="pdf-content" style="padding: 1.5rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h3>
        <i class="fas fa-calendar-day" style="color: #0a66c2; margin-right: 0.5rem;"></i>
        ${data.day || 'Today'} - ${formatDateLong(todayISO)}
      </h3>
      <span class="badge" style="background: rgba(16,185,129,0.15); color: #059669;">
        <i class="fas fa-user"></i> ${data.todName || data.todDisplayName || 'TOD'}
      </span>
    </div>

    ${tableHTML}

    <h4>
      <i class="fas fa-comment-dots" style="color: #0a66c2;"></i>
      TOD Answer:
    </h4>
    <div class="answer-card">
      <i class="fas fa-quote-left" style="color: #0a66c2; opacity: 0.5; margin-right: 0.5rem;"></i>
      ${data.todAnswer || data.answer || "No answer provided"}
    </div>

    <h4>
      <i class="fas fa-reply" style="color: #0a66c2;"></i>
      HT Response:
    </h4>
    <div class="input-icon-wrapper">
      <i class="fas fa-pen-to-square"></i>
      <textarea id="htResponse" placeholder="Write your response here...">${data.htAnswer || ""}</textarea>
    </div>

    <div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
      <button class="btn-success" onclick="saveHT('${todayISO}')">
        <i class="fas fa-save"></i> Save Response
      </button>
      <button class="btn-primary" onclick="downloadPDFFromElement('todayReportContainer', 'Today_Report_${todayISO}.pdf')">
        <i class="fas fa-file-pdf"></i> Download PDF
      </button>
    </div>
  </div>
  `;
};

/* ================= SAVE HT RESPONSE ================= */

window.saveHT = async function(id) {
  const text = document.getElementById("htResponse").value;

  await setDoc(doc(db, "attendance", id), {
    htAnswer: text,
    status: "Reviewed",
    reviewedBy: auth.currentUser?.email || 'HT',
    reviewedAt: new Date()
  }, { merge: true });

  alert("✅ Response saved successfully");
};

/* ================= PDF DOWNLOAD FUNCTION ================= */
window.downloadPDFFromElement = async function(elementId, filename) {
  const element = document.getElementById(elementId);
  if (!element) {
    alert("Could not find content to download");
    return;
  }
  
  try {
    const { jsPDF } = window.jspdf;
    const canvas = await html2canvas(element, {
      scale: 2,
      backgroundColor: '#ffffff',
      logging: false,
      allowTaint: true,
      useCORS: true
    });
    
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: 'a4'
    });
    
    const imgWidth = 210;
    const pageHeight = 297;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    let heightLeft = imgHeight;
    let position = 0;
    
    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;
    
    while (heightLeft >= 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }
    
    pdf.save(filename || "HT_Report.pdf");
  } catch (error) {
    console.error("PDF generation error:", error);
    alert("Error generating PDF: " + error.message);
  }
};

/* ================= SHOW DUTY HISTORY ================= */

window.showDutyHistory = async function() {
  // Set active nav button
  document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById('navDutyHistory').classList.add('active');

  const usersSnap = await getDocs(collection(db, "users"));

  let html = `<div class="glass-card">
    <h3>
      <i class="fas fa-users" style="color: #8e44ad; margin-right: 0.5rem;"></i>
      Select Teacher On Duty
    </h3>
    <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem;">`;

  usersSnap.forEach(d => {
    const u = d.data();
    if (u.role === "TOD") {
      html += `
        <button class="btn-info" onclick="openTodHistory('${d.id}', '${u.name}')">
          <i class="fas fa-user-tie"></i> ${u.name}
        </button>
      `;
    }
  });

  html += `</div></div>`;

  document.getElementById("content").innerHTML = html;
};

/* ================= OPEN TOD HISTORY ================= */

window.openTodHistory = async function(todId, name, selectedYear = null) {
  // Get the user document to get the email
  const userDoc = await getDoc(doc(db, "users", todId));
  const userEmail = userDoc.exists() ? userDoc.data().email : todId;
  
  const q = query(collection(db, "attendance"), where("todName", "==", userEmail));
  const snap = await getDocs(q);

  if (snap.empty) {
    document.getElementById("content").innerHTML = `
      <div class="empty-state">
        <i class="fas fa-info-circle"></i> No attendance records found for ${name}
      </div>
    `;
    return;
  }

  let records = [];
  snap.forEach(d => {
    records.push({
      id: d.id,
      ...d.data()
    });
  });

  // Group records by year and week
  const recordsByYearWeek = {};
  const availableYears = new Set();
  
  records.forEach(r => {
    const date = new Date(r.id);
    const year = date.getFullYear();
    const week = getWeekNumber(date);
    const dayName = r.day;
    
    availableYears.add(year);
    
    if (!recordsByYearWeek[year]) {
      recordsByYearWeek[year] = {};
    }
    if (!recordsByYearWeek[year][week]) {
      recordsByYearWeek[year][week] = {
        weekNumber: week,
        days: {}
      };
    }
    
    recordsByYearWeek[year][week].days[dayName] = {
      id: r.id,
      date: r.id,
      day: dayName,
      present: r.data ? r.data.reduce((sum, cls) => sum + (parseInt(cls.preB) || 0) + (parseInt(cls.preG) || 0), 0) : 0,
      total: r.data ? r.data.reduce((sum, cls) => sum + (parseInt(cls.regB) || 0) + (parseInt(cls.regG) || 0), 0) : 0,
      hasAnswer: !!(r.todAnswer || r.answer),
      hasHTResponse: !!(r.htAnswer)
    };
  });

  // Sort years descending
  const sortedYears = Array.from(availableYears).sort((a, b) => b - a);
  
  // Use selected year or first year
  const currentYear = selectedYear || sortedYears[0];
  
  // Year selector
  let yearSelector = `
    <div class="year-selector">
      <span style="font-weight: 600; color: #1e4c6b;">Select Year:</span>
  `;
  
  sortedYears.forEach(year => {
    yearSelector += `
      <button class="year-btn ${year === currentYear ? 'active' : ''}" 
              onclick="openTodHistory('${todId}', '${name}', ${year})">
        ${year}
      </button>
    `;
  });
  
  yearSelector += `</div>`;

  let html = `<div class="glass-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h3>
        <i class="fas fa-history" style="color: #8e44ad; margin-right: 0.5rem;"></i>
        ${name} - Duty History
      </h3>
      <span class="badge" style="background: rgba(142,68,173,0.15); color: #71368a;">
        <i class="fas fa-calendar"></i> ${records.length} Total Reports
      </span>
    </div>
    
    <div style="margin-bottom: 1rem;">
      <button class="btn-outline" onclick="showDutyHistory()" style="border-color: #8e44ad; color: #8e44ad;">
        <i class="fas fa-arrow-left"></i> Back to TOD List
      </button>
    </div>
    
    ${yearSelector}
    `;

  // Get weeks for current year and sort descending
  const weeks = Object.values(recordsByYearWeek[currentYear] || {}).sort((a, b) => b.weekNumber - a.weekNumber);
  
  if (weeks.length === 0) {
    html += `<div class="empty-state">No records found for ${currentYear}</div>`;
  } else {
    weeks.forEach(week => {
      const weekData = week;
      const days = weekData.days;
      
      // Count how many days in this week
      const dayCount = Object.keys(days).length;
      
      html += `
        <div class="week-group">
          <div class="week-header">
            <i class="fas fa-calendar-week"></i>
            Week ${weekData.weekNumber}
            <span class="badge" style="background: white; color: #71368a; margin-left: 1rem;">
              ${dayCount} day${dayCount > 1 ? 's' : ''}
            </span>
          </div>
          <div class="week-days">
      `;
      
      // Sort days in week order
      const dayOrder = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
      dayOrder.forEach(dayName => {
        if (days[dayName]) {
          const day = days[dayName];
          const percentage = day.total > 0 ? Math.round((day.present / day.total) * 100) : 0;
          
          html += `
            <div class="record-item">
              <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 1.5rem;">
                <span class="record-date">
                  <i class="fas fa-calendar-day" style="color: #0a66c2; margin-right: 0.5rem;"></i>
                  ${dayName} - ${formatDateLong(day.date)}
                </span>
                <span class="record-badge">
                  <i class="fas fa-user-graduate"></i> Present: ${day.present}/${day.total} (${percentage}%)
                </span>
                ${day.hasAnswer ? 
                  `<span class="record-badge" style="background: rgba(16,185,129,0.1); color: #059669;">
                    <i class="fas fa-check-circle"></i> Answered
                  </span>` : 
                  `<span class="record-badge" style="background: rgba(245,158,11,0.1); color: #d97706;">
                    <i class="fas fa-clock"></i> No Answer
                  </span>`
                }
                ${day.hasHTResponse ? 
                  `<span class="record-badge" style="background: rgba(10,102,194,0.1); color: #0a66c2;">
                    <i class="fas fa-reply"></i> HT Responded
                  </span>` : ''
                }
              </div>
              <button class="btn-primary btn-small" onclick="openRecord('${day.id}')">
                <i class="fas fa-eye"></i> View
              </button>
            </div>
          `;
        }
      });
      
      html += `</div></div>`;
    });
  }

  html += `</div>`;
  document.getElementById("content").innerHTML = html;
};

/* ================= OPEN RECORD ================= */

window.openRecord = async function(id) {
  const docSnap = await getDoc(doc(db, "attendance", id));
  if (!docSnap.exists()) return;

  const data = docSnap.data();
  
  // Generate table HTML from data
  let tableHTML = data.data ? generateTableFromData(data.data) : (data.tableHTML || "<p>No attendance data available</p>");

  document.getElementById("content").innerHTML = `
  <div id="recordReportContainer" class="pdf-content" style="padding: 1.5rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h3>
        <i class="fas fa-calendar-day" style="color: #0a66c2; margin-right: 0.5rem;"></i>
        ${data.day} - ${formatDateLong(id)}
      </h3>
      <span class="badge" style="background: rgba(16,185,129,0.15); color: #059669;">
        <i class="fas fa-user"></i> ${data.todName || data.todDisplayName || 'TOD'}
      </span>
    </div>

    <div style="margin-bottom: 1rem;">
      <button class="btn-outline" onclick="openTodHistory('${data.todId}', '${data.todName}')" style="border-color: #8e44ad; color: #8e44ad;">
        <i class="fas fa-arrow-left"></i> Back to History
      </button>
    </div>

    ${tableHTML}

    <h4>
      <i class="fas fa-comment-dots" style="color: #0a66c2;"></i>
      TOD Answer:
    </h4>
    <div class="answer-card">
      <i class="fas fa-quote-left" style="color: #0a66c2; opacity: 0.5; margin-right: 0.5rem;"></i>
      ${data.todAnswer || data.answer || "No answer provided"}
    </div>

    <h4>
      <i class="fas fa-reply" style="color: #0a66c2;"></i>
      HT Response:
    </h4>
    <div style="background: rgba(255,255,255,0.7); backdrop-filter: blur(8px); border-radius: 20px; padding: 1.2rem; border-left: 6px solid #f59e0b; margin-top: 0.5rem;">
      <i class="fas fa-quote-left" style="color: #f59e0b; opacity: 0.5; margin-right: 0.5rem;"></i>
      ${data.htAnswer || "No response yet"}
    </div>

    <div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
      <button class="btn-primary" onclick="downloadPDFFromElement('recordReportContainer', 'Record_Report_${id}.pdf')">
        <i class="fas fa-file-pdf"></i> Download PDF
      </button>
    </div>
  </div>
  `;
};

/* ================= PLAN DUTY - SHOWS REAL MONDAY-FRIDAY DATES ================= */

window.showPlanDuty = async function(){
  // Set active nav button
  document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById('navPlanDuty').classList.add('active');

  let html = `
    <h3><i class="fas fa-calendar-plus" style="color: #0a66c2; margin-right: 0.5rem;"></i> Plan Duty - Weekly Schedule</h3>
    <div class="duty-card">
  `;

  const snapshot = await getDocs(collection(db, "users"));

  let todList = [];

  snapshot.forEach(docSnap => {
    let u = docSnap.data();
    if (u.role === "TOD") {
      todList.push({id: docSnap.id, name: u.name, email: u.email});
    }
  });

  // Get current week number
  const currentWeek = getCurrentWeekNumber();
  const currentYear = new Date().getFullYear();
  
  // Show next 4 weeks for planning
  for (let i = 0; i < 4; i++) {
    const weekNum = currentWeek + i;
    const weekDates = getWeekDates(weekNum, currentYear);
    const isCurrentWeek = (i === 0);
    
    // Get assigned TOD for this week
    let assignedTod = "";
    try {
      const planSnap = await getDoc(doc(db, "dutyPlan", `week_${weekNum}`));
      if (planSnap.exists()) {
        const todId = planSnap.data().todId;
        const assigned = todList.find(t => t.id === todId);
        assignedTod = assigned ? assigned.id : "";
      }
    } catch (e) {
      console.log("No plan for week " + weekNum);
    }

    // Create dates display
    let datesHtml = '';
    weekDates.forEach(day => {
      datesHtml += `
        <div class="date-row">
          <span class="date-label">${day.name}:</span>
          <span class="date-value">${formatDate(day.date)}</span>
        </div>
      `;
    });

    html += `
    <div class="week-row ${isCurrentWeek ? 'current-week' : ''}">
      <div class="week-number">
        <i class="fas fa-calendar-week"></i> Week ${weekNum}
      </div>
      <div class="week-dates">
        ${datesHtml}
        ${isCurrentWeek ? '<span class="badge" style="background: #10b981; color: white; margin-top: 0.5rem;">Current Week</span>' : ''}
      </div>
      <div style="flex: 1;">
        <div class="input-icon-wrapper">
          <i class="fas fa-user-tie"></i>
          <select id="select_week_${weekNum}">
            <option value="">-- Select TOD for this week --</option>
            ${todList.map(t => `<option value="${t.id}" ${t.id === assignedTod ? 'selected' : ''}>${t.name} (${t.email})</option>`).join("")}
          </select>
        </div>
      </div>
      <button class="btn-success" onclick="savePlan('${weekNum}')">
        <i class="fas fa-save"></i> Assign
      </button>
    </div>
    `;
  }

  html += `
    <div class="info-note" style="margin-top: 1rem;">
      <i class="fas fa-info-circle"></i> Assign TODs for each week. Only the assigned TOD can edit attendance during their week.
    </div>
  </div>
  `;

  document.getElementById("content").innerHTML = html;
}

window.savePlan = async function(weekNum){
  const selectId = `select_week_${weekNum}`;
  const todId = document.getElementById(selectId).value;
  
  if (!todId) {
    alert("Please select a TOD");
    return;
  }

  await setDoc(doc(db, "dutyPlan", `week_${weekNum}`), {
    weekNumber: parseInt(weekNum),
    todId: todId,
    assignedAt: new Date(),
    assignedBy: auth.currentUser?.email || 'HT'
  });

  alert(`✅ Week ${weekNum} assigned successfully`);
}

/* ================= LOGOUT BUTTONS ================= */

// Attach logout buttons
document.getElementById('logoutBtn').addEventListener('click', window.logout);
document.getElementById('logoutBtnBottom').addEventListener('click', window.logout);

// Make functions global
window.showUsers = showUsers;
window.showToday = showToday;
window.showDutyHistory = showDutyHistory;
window.openTodHistory = openTodHistory;
window.openRecord = openRecord;
window.showPlanDuty = showPlanDuty;
window.savePlan = savePlan;
window.saveHT = saveHT;
window.downloadPDFFromElement = downloadPDFFromElement;
window.logout = logout;
window.getCurrentWeekNumber = getCurrentWeekNumber;

// Set initial active state
window.addEventListener('load', function() {
  document.getElementById('navToday').classList.add('active');
});
</script>

</body>
</html>
