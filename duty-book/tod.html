<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<title>TOD Dashboard ¬∑ BGT Attendance</title>

<!-- Font Awesome 6 (free) for icons & brand -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<!-- jsPDF for PDF downloads -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- html2canvas for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
  /* ---------- GLOBAL & VARIABLES ---------- */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  }

  body {
    background: linear-gradient(145deg, #f0f4fa 0%, #e9eef4 100%);
    min-height: 100vh;
    padding: clamp(1rem, 5vw, 2rem);
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    line-height: 1.5;
  }

  /* ---------- DECORATIVE RADIAL CIRCLES (fixed) ---------- */
  .bg-circle-1, .bg-circle-2 {
    position: fixed;
    width: 280px;
    height: 280px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(0,112,243,0.08) 0%, transparent 80%);
    pointer-events: none;
    z-index: 0;
  }
  .bg-circle-1 {
    top: 2%;
    left: 2%;
    width: clamp(200px, 30vw, 280px);
    height: clamp(200px, 30vw, 280px);
    background: radial-gradient(circle, rgba(0,112,243,0.08) 0%, transparent 75%);
  }
  .bg-circle-2 {
    bottom: 5%;
    right: 2%;
    width: clamp(240px, 35vw, 340px);
    height: clamp(240px, 35vw, 340px);
    background: radial-gradient(circle, rgba(0,180,210,0.07) 0%, transparent 80%);
  }

  /* ---------- MAIN CONTAINER (above circles) ---------- */
  .dashboard-container {
    max-width: 1400px;
    width: 100%;
    position: relative;
    z-index: 10;
    animation: fadeSlide 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  }

  /* ---------- GLASS CARD (reusable) ---------- */
  .glass-card {
    background: rgba(255,255,255,0.8);
    backdrop-filter: blur(16px) saturate(180%);
    -webkit-backdrop-filter: blur(16px) saturate(180%);
    border-radius: clamp(24px, 5vw, 32px);
    box-shadow: 0 20px 35px -10px rgba(0,20,40,0.15);
    border: 1px solid rgba(255,255,255,0.3);
    box-shadow: 0 0 0 1px rgba(255,255,255,0.5) inset, 0 20px 35px -10px rgba(0,20,40,0.15);
    padding: clamp(1.2rem, 4vw, 2rem);
    transition: box-shadow 0.25s ease, background 0.25s;
    margin-bottom: 1.8rem;
  }
  .glass-card:hover {
    background: rgba(255,255,255,0.95);
    box-shadow: 0 24px 42px -12px rgba(0,60,120,0.2), 0 0 0 1px rgba(255,255,255,0.7) inset;
  }

  /* ---------- FLUID TYPOGRAPHY / CLAMP ---------- */
  body, input, select, button, td, th, li, .badge, .info-note, h2, h3, h4, textarea {
    font-size: clamp(0.75rem, 1.8vw, 0.9rem);
  }

  h2 {
    font-size: clamp(1.3rem, 4vw, 1.6rem);
    font-weight: 600;
    color: #0b2b4e;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  h3 {
    font-size: clamp(1.1rem, 3.5vw, 1.3rem);
    font-weight: 600;
    color: #1e4c6b;
    margin-bottom: 1.2rem;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  h4 {
    font-size: clamp(1rem, 3vw, 1.1rem);
    font-weight: 600;
    color: #065f46;
    margin: 1rem 0 0.5rem 0;
  }
  .section-icon {
    font-size: clamp(1.4rem, 4vw, 1.6rem);
    color: #10b981;
    background: rgba(16,185,129,0.08);
    padding: 0.6rem;
    border-radius: 18px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  /* ---------- HEADER CARD ---------- */
  .header-card {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 2rem;
  }
  .brand {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .brand i {
    font-size: clamp(1.6rem, 5vw, 2rem);
    color: #10b981;
    filter: drop-shadow(0 4px 6px rgba(16,185,129,0.2));
  }
  .brand-text {
    background: linear-gradient(150deg, #0b2b4e, #1e4c6b);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    font-weight: 700;
    font-size: clamp(1.4rem, 5vw, 1.9rem);
    letter-spacing: -0.01em;
  }
  .role-badge {
    background: rgba(16,185,129,0.15);
    border-radius: 40px;
    color: #065f46;
    padding: 0.5rem 1.5rem;
    font-weight: 600;
    font-size: 0.95rem;
    border: 1px solid rgba(255,255,255,0.3);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* User Info Badge */
  .user-info-badge {
    background: rgba(255,255,255,0.2);
    border-radius: 40px;
    padding: 0.3rem 1.2rem;
    font-size: 0.9rem;
    color: #065f46;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    border: 1px solid rgba(255,255,255,0.3);
    backdrop-filter: blur(4px);
  }
  .user-info-badge i {
    color: #10b981;
  }

  /* Super User Badge */
  .super-badge {
    background: rgba(139,92,246,0.15);
    color: #7c3aed;
    border: 1px solid rgba(139,92,246,0.3);
  }

  /* Super User Info */
  .super-user-info {
    margin-bottom: 1rem;
    animation: fadeSlide 0.5s ease;
  }

  /* ---------- FORM INPUTS WITH ICONS ---------- */
  .input-icon-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    width: 100%;
  }
  .input-icon-wrapper i {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: #6b8ca3;
    font-size: 1rem;
    z-index: 2;
  }
  .input-icon-wrapper input,
  .input-icon-wrapper textarea {
    width: 100%;
    padding: 0.85rem 1rem 0.85rem 2.8rem;
    background: rgba(255,255,255,0.8);
    border: 1.5px solid rgba(200,215,225,0.7);
    border-radius: 20px;
    font-size: clamp(0.8rem, 2vw, 0.95rem);
    transition: all 0.2s;
    outline: none;
    color: #1e2f3e;
  }
  .input-icon-wrapper textarea {
    padding: 1rem 1rem 1rem 2.8rem;
    resize: vertical;
    min-height: 120px;
    line-height: 1.6;
  }
  .input-icon-wrapper input:focus,
  .input-icon-wrapper textarea:focus {
    border-color: #10b981;
    background: white;
    box-shadow: 0 6px 14px rgba(16,185,129,0.08);
  }
  input[readonly] {
    background: rgba(200,215,225,0.2);
    cursor: not-allowed;
  }

  /* ---------- BUTTON VARIANTS ---------- */
  button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.6rem;
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 40px;
    padding: 0.7rem 1.5rem;
    font-weight: 600;
    font-size: clamp(0.8rem, 2vw, 0.95rem);
    transition: all 0.2s;
    cursor: pointer;
    margin: 0.3rem;
    background: transparent;
    color: inherit;
    white-space: nowrap;
  }
  button i {
    font-size: 0.95rem;
  }
  .btn-success { background: #10b981; color: white; }
  .btn-success:hover { background: #059669; scale: 1.02; }
  .btn-primary { background: #0a66c2; color: white; }
  .btn-primary:hover { background: #004a8f; scale: 1.02; }
  .btn-info { background: #2563eb; color: white; }
  .btn-info:hover { background: #1e4c8f; scale: 1.02; }
  .btn-outline {
    background: transparent;
    border: 1.5px solid #10b981;
    color: #10b981;
  }
  .btn-outline:hover { background: #10b981; color: white; scale: 1.02; }
  .btn-danger {
    background: #ef4444;
    color: white;
  }
  .btn-danger:hover { background: #dc2626; scale: 1.02; }
  .btn-warning {
    background: #f59e0b;
    color: white;
  }
  .btn-warning:hover { background: #d97706; scale: 1.02; }
  .btn-small {
    padding: 0.4rem 1rem;
    font-size: 0.8rem;
  }
  .btn-super {
    background: #8b5cf6;
    color: white;
  }
  .btn-super:hover { background: #7c3aed; scale: 1.02; }
  
  @media (max-width: 768px) {
    button { width: 100%; justify-content: center; }
  }

  /* ---------- GRID & FLEX ---------- */
  .grid-auto {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(100%, 180px), 1fr));
    gap: 1rem;
    align-items: end;
  }
  .flex-wrap {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
  }

  /* ---------- TABLE STYLES ---------- */
  .table-responsive {
    overflow-x: auto;
    margin-top: 1.5rem;
    border-radius: 20px;
    width: 100%;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: rgba(255,255,255,0.4);
    backdrop-filter: blur(4px);
    border-radius: 20px;
    border-style: hidden;
    box-shadow: 0 0 0 1px rgba(16,185,129,0.15);
  }
  th {
    background: #10b981;
    color: white;
    padding: 0.7rem 0.5rem;
    font-weight: 600;
    text-align: center;
    font-size: 0.8rem;
    border: 1px solid rgba(255,255,255,0.2);
  }
  td {
    padding: 0.5rem 0.3rem;
    border-bottom: 1px solid rgba(16,185,129,0.1);
    text-align: center;
    vertical-align: middle;
  }
  tbody tr:hover {
    background: rgba(16,185,129,0.04);
  }
  td input {
    width: 55px;
    padding: 0.4rem;
    border-radius: 12px;
    border: 1.5px solid rgba(200,215,225,0.7);
    background: white;
    text-align: center;
  }
  td input:focus {
    border-color: #10b981;
    box-shadow: 0 0 0 3px rgba(16,185,129,0.1);
    outline: none;
  }
  td input[readonly] {
    background: rgba(200,215,225,0.2);
    color: #065f46;
    font-weight: 600;
  }
  .totalRow {
    background: rgba(16,185,129,0.15);
    font-weight: 700;
  }
  .grandTotal {
    font-weight: 700;
    color: #065f46;
  }
  
  /* ---------- BEAUTIFUL CALENDAR CARD (SAME AS HT) ---------- */
  .calendar-card {
    background: rgba(255,255,255,0.7);
    backdrop-filter: blur(8px);
    border-radius: 24px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid rgba(16,185,129,0.2);
  }
  
  .calendar-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px dashed rgba(16,185,129,0.2);
  }
  
  .calendar-header i {
    font-size: 2rem;
    color: #10b981;
  }
  
  .calendar-header h3 {
    color: #0b2b4e;
    margin-bottom: 0;
  }
  
  .week-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 2rem;
    margin-bottom: 1.5rem;
    padding: 1.2rem;
    background: white;
    border-radius: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    border-left: 6px solid #10b981;
    transition: all 0.2s;
  }
  
  .week-row:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(16,185,129,0.1);
  }
  
  .week-number {
    font-weight: 700;
    color: #10b981;
    min-width: 90px;
    font-size: 1.2rem;
    background: rgba(16,185,129,0.1);
    padding: 0.5rem 1rem;
    border-radius: 40px;
    text-align: center;
  }
  
  .week-dates {
    flex: 2;
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }
  
  .date-chip {
    background: rgba(16,185,129,0.05);
    border-radius: 40px;
    padding: 0.5rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.8rem;
    border: 1px solid rgba(16,185,129,0.1);
  }
  
  .date-chip .day {
    font-weight: 600;
    color: #065f46;
    min-width: 60px;
  }
  
  .date-chip .date {
    background: white;
    padding: 0.3rem 1rem;
    border-radius: 30px;
    font-weight: 600;
    color: #10b981;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
  }
  
  .current-week .date-chip .date {
    background: #10b981;
    color: white;
  }
  
  .current-week {
    background: rgba(16,185,129,0.05);
    border-left: 6px solid #10b981;
  }
  
  .assigned-badge {
    background: #10b981;
    color: white;
    padding: 0.3rem 1rem;
    border-radius: 30px;
    font-size: 0.8rem;
    font-weight: 600;
    white-space: nowrap;
  }
  
  .not-assigned-badge {
    background: #ef4444;
    color: white;
    padding: 0.3rem 1rem;
    border-radius: 30px;
    font-size: 0.8rem;
    font-weight: 600;
    white-space: nowrap;
  }
  
  .sunday-message {
    background: #f59e0b;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 40px;
    font-size: 0.9rem;
    font-weight: 600;
    display: inline-block;
    margin-bottom: 1rem;
  }

  /* ---------- PERCENTAGE BADGE ---------- */
  .percentage-badge {
    background: rgba(16,185,129,0.2);
    border-radius: 40px;
    padding: 0.4rem 1.2rem;
    font-size: 0.9rem;
    font-weight: 700;
    color: #065f46;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    border: 1px solid rgba(16,185,129,0.3);
    backdrop-filter: blur(4px);
  }
  .percentage-value {
    background: white;
    padding: 0.2rem 0.8rem;
    border-radius: 30px;
    color: #10b981;
    font-weight: 800;
  }

  /* ---------- CLASS CARDS (CT VIEW) ---------- */
  .class-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
  }
  .class-card {
    background: rgba(255,255,255,0.7);
    backdrop-filter: blur(8px);
    border-radius: 24px;
    padding: 1.5rem;
    border: 1px solid rgba(16,185,129,0.2);
    transition: all 0.2s;
  }
  .class-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(16,185,129,0.1);
  }
  .class-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px dashed rgba(16,185,129,0.2);
  }
  .class-name {
    font-size: 1.2rem;
    font-weight: 700;
    color: #065f46;
  }

  /* Student List */
  .student-list {
    margin: 1rem 0;
    max-height: 300px;
    overflow-y: auto;
    border-radius: 16px;
    background: rgba(255,255,255,0.5);
    padding: 0.5rem;
  }
  .student-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem;
    margin: 0.25rem 0;
    background: white;
    border-radius: 12px;
    border-left: 4px solid;
    transition: all 0.2s;
  }
  .student-item.boys { border-left-color: #0a66c2; }
  .student-item.girls { border-left-color: #ec4899; }
  .student-info {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    flex: 1;
  }
  .student-name {
    font-weight: 500;
    color: #1e293b;
  }
  .student-gender {
    font-size: 0.7rem;
    padding: 0.2rem 0.5rem;
    border-radius: 30px;
    background: #f1f5f9;
  }
  .student-gender.boys { background: rgba(10,102,194,0.1); color: #0a66c2; }
  .student-gender.girls { background: rgba(236,72,153,0.1); color: #be185d; }
  
  .attendance-status {
    display: flex;
    gap: 0.3rem;
  }
  .status-btn {
    padding: 0.3rem 0.6rem;
    border-radius: 20px;
    border: 1px solid #e2e8f0;
    background: white;
    font-size: 0.7rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .status-btn.present.active { background: #10b981; color: white; border-color: #10b981; }
  .status-btn.absent.active { background: #ef4444; color: white; border-color: #ef4444; }
  .status-btn.sick.active { background: #f59e0b; color: white; border-color: #f59e0b; }
  .status-btn.permission.active { background: #8b5cf6; color: white; border-color: #8b5cf6; }

  .add-student-form {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
  }
  .add-student-form input {
    flex: 1;
    padding: 0.5rem;
    border-radius: 20px;
    border: 1.5px solid rgba(200,215,225,0.7);
  }
  .add-student-form select {
    padding: 0.5rem;
    border-radius: 20px;
    border: 1.5px solid rgba(200,215,225,0.7);
    background: white;
  }

  /* ---------- HISTORY SECTION ---------- */
  .history-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin: 1.5rem 0;
    padding: 1rem;
    background: rgba(255,255,255,0.5);
    border-radius: 20px;
  }
  .date-picker {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex: 1;
  }
  .date-picker input {
    padding: 0.5rem;
    border-radius: 20px;
    border: 1.5px solid rgba(200,215,225,0.7);
  }
  .year-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 0.5rem;
    margin: 1rem 0;
  }
  .month-card {
    background: white;
    padding: 1rem;
    border-radius: 16px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
  }
  .month-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  .month-card.active { border-color: #10b981; background: rgba(16,185,129,0.1); }
  .month-name { font-weight: 600; color: #065f46; }
  .month-count { font-size: 0.8rem; color: #6b8ca3; }

  .history-table {
    max-height: 400px;
    overflow-y: auto;
    margin-top: 1rem;
  }
  .history-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    margin: 0.5rem 0;
    background: white;
    border-radius: 16px;
    border-left: 6px solid #10b981;
  }
  .history-date {
    font-weight: 600;
    color: #1e293b;
  }
  .history-stats {
    display: flex;
    gap: 1rem;
  }
  .history-actions {
    display: flex;
    gap: 0.5rem;
  }

  /* ---------- PDF DOWNLOAD BUTTONS ---------- */
  .pdf-download-btn {
    background: #ef4444;
    color: white;
    border: none;
  }
  .pdf-download-btn:hover {
    background: #dc2626;
  }

  /* ---------- AUTO-SAVE INDICATOR ---------- */
  .auto-save-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.3rem 1rem;
    background: rgba(16,185,129,0.1);
    border-radius: 30px;
    color: #065f46;
    font-size: 0.8rem;
  }

  /* ---------- TAB NAVIGATION ---------- */
  .tab-navigation {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid rgba(16,185,129,0.2);
    padding-bottom: 0.5rem;
  }
  .tab-btn {
    background: transparent;
    border: none;
    padding: 0.8rem 1.5rem;
    font-weight: 600;
    color: #6b8ca3;
    cursor: pointer;
    border-radius: 40px 40px 0 0;
    transition: all 0.2s;
  }
  .tab-btn:hover { color: #10b981; background: rgba(16,185,129,0.05); }
  .tab-btn.active { color: #10b981; background: rgba(16,185,129,0.1); position: relative; }
  .tab-btn.active::after {
    content: '';
    position: absolute;
    bottom: -7px;
    left: 0;
    right: 0;
    height: 3px;
    background: #10b981;
    border-radius: 3px 3px 0 0;
  }

  /* ---------- ACTIVITY SECTION ---------- */
  #activitySection {
    display: none;
    margin-top: 2rem;
    border-top: 2px dashed rgba(16,185,129,0.3);
    padding-top: 1.5rem;
  }

  /* ---------- SUMMARY CARD ---------- */
  .summary-card {
    background: rgba(255,255,255,0.7);
    backdrop-filter: blur(8px);
    border-radius: 24px;
    padding: 1.2rem;
    margin: 1.5rem 0 0.5rem 0;
    border: 1px solid rgba(16,185,129,0.3);
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
  }
  .summary-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.5rem 1rem;
    background: white;
    border-radius: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.02);
  }
  .summary-label {
    font-size: 0.75rem;
    color: #6b8ca3;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .summary-value {
    font-size: 1.2rem;
    font-weight: 700;
    color: #065f46;
  }
  .summary-value small {
    font-size: 0.8rem;
    font-weight: 400;
    color: #6b8ca3;
  }

  .badge {
    background: rgba(16,185,129,0.1);
    border-radius: 30px;
    padding: 0.3rem 1rem;
    font-size: 0.8rem;
    color: #065f46;
    display: inline-block;
  }
  .badge-success { background: rgba(16,185,129,0.15); color: #059669; }
  .badge-warning { background: rgba(245,158,11,0.15); color: #d97706; }
  
  .empty-state {
    text-align: center;
    padding: 2rem;
    color: #6b8ca3;
    background: rgba(255,255,255,0.5);
    border-radius: 24px;
    font-style: italic;
  }

  @keyframes fadeSlide {
    0% { opacity: 0; transform: translateY(12px); }
    100% { opacity: 1; transform: translateY(0); }
  }

  #todayHeader {
    font-weight: 600;
    color: #1e4c6b;
    background: rgba(255,255,255,0.4);
    padding: 0.5rem 1.5rem;
    border-radius: 40px;
    display: inline-block;
    backdrop-filter: blur(4px);
    margin-bottom: 1.5rem;
  }

  .day-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.8rem;
    margin: 1rem 0;
  }
  
  /* ---------- LOGOUT BUTTON CONTAINER ---------- */
  .logout-container {
    display: flex;
    justify-content: flex-end;
    margin-top: 0.5rem;
    margin-bottom: 1rem;
  }

  /* ---------- USER NAME DISPLAY ---------- */
  .user-name-display {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1.2rem;
    background: rgba(255,255,255,0.3);
    border-radius: 40px;
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255,255,255,0.3);
  }
  .user-name-display i {
    color: #10b981;
  }
  .user-name-display span {
    font-weight: 600;
    color: #065f46;
  }
</style>
</head>

<body>
<div class="bg-circle-1"></div>
<div class="bg-circle-2"></div>

<div class="dashboard-container">
  <!-- HEADER CARD with User Info -->
  <div class="glass-card header-card">
    <div class="brand">
      <i class="fas fa-clipboard-check"></i>
      <span class="brand-text">TOD Dashboard</span>
    </div>
    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
      <!-- User Name/Email Display -->
      <div class="user-name-display" id="userNameDisplay">
        <i class="fas fa-user-circle"></i>
        <span id="userNameText">Loading...</span>
      </div>
      <div class="role-badge" id="roleBadge">
        <i class="fas fa-user-tie"></i> 
        <span id="roleText">Teacher On Duty</span>
        <span class="badge" id="classCount" style="margin-left: 0.5rem;"></span>
      </div>
    </div>
  </div>

  <!-- LOGOUT BUTTON - TOP RIGHT -->
  <div class="logout-container">
    <button id="logoutBtn" class="btn-danger" style="border-width: 1.5px; padding: 0.7rem 2.2rem;">
      <i class="fas fa-sign-out-alt"></i> Logout
    </button>
  </div>

  <!-- SUPER USER INFO WILL BE INSERTED HERE DYNAMICALLY -->

  <!-- MAIN DASHBOARD CARD -->
  <div class="glass-card">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 0.5rem;">
      <h2>
        <i class="fas fa-calendar-alt" style="color: #10b981;"></i>
        <span id="todayHeader"></span>
      </h2>
      
      <!-- PRESENT PERCENTAGE DISPLAY -->
      <div id="presentPercentageDisplay" class="percentage-badge">
        <i class="fas fa-chart-pie"></i> Present Rate: 
        <span id="presentPercentageValue" class="percentage-value">0%</span>
      </div>
    </div>

    <!-- SUNDAY MESSAGE (if today is Sunday) -->
    <div id="sundayMessage" class="sunday-message" style="display: none;">
      <i class="fas fa-sun"></i> Today is Sunday. Your week starts tomorrow (Monday). No editing until Monday.
    </div>

    <!-- TAB NAVIGATION -->
    <div class="tab-navigation" id="tabNavigation">
      <button class="tab-btn active" onclick="switchTab('tod')" id="tabTOD">TOD Dashboard</button>
      <button class="tab-btn" onclick="switchTab('ct')" id="tabCT">My Classes (CT)</button>
      <button class="tab-btn" onclick="switchTab('history')" id="tabHistory">Full History</button>
    </div>

    <!-- TOD SECTION -->
    <div id="todSection">
      <!-- BEAUTIFUL CALENDAR CARD -->
      <div class="calendar-card">
        <div class="calendar-header">
          <i class="fas fa-calendar-alt"></i>
          <h3>Your Duty Schedule</h3>
        </div>
        <div id="assignedWeekCalendar"></div>
      </div>

      <!-- ATTENDANCE TABLE -->
      <div id="attendanceTable"></div>

      <!-- ACTION BUTTONS -->
      <div class="flex-wrap" style="justify-content: space-between; margin-top: 1.5rem;">
        <button id="saveAttendanceBtn" class="btn-success" onclick="saveAttendance()">
          <i class="fas fa-save"></i> Save Attendance
        </button>
        <div style="display: flex; gap: 0.5rem;">
          <button class="btn-primary" onclick="downloadTODReport()">
            <i class="fas fa-file-pdf"></i> Download Report
          </button>
          <button class="btn-info" onclick="showActivity()">
            <i class="fas fa-history"></i> My Activity
          </button>
        </div>
      </div>
    </div>

    <!-- CT SECTION -->
    <div id="ctSection" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <div class="auto-save-indicator" id="autoSaveIndicator">
          <i class="fas fa-circle"></i> Auto-save ready
        </div>
        <button class="btn-primary btn-small" onclick="downloadCTReport()">
          <i class="fas fa-file-pdf"></i> Download My Classes
        </button>
      </div>
      <div id="classCardsContainer" class="class-cards"></div>
    </div>

    <!-- HISTORY SECTION -->
    <div id="historySection" style="display: none;">
      <div class="history-controls">
        <div class="date-picker">
          <i class="fas fa-calendar"></i>
          <input type="month" id="historyMonth" onchange="loadMonthHistory()">
        </div>
        <button class="btn-warning btn-small" onclick="loadFullHistory()">
          <i class="fas fa-calendar-alt"></i> Year View
        </button>
        <button class="btn-danger btn-small" onclick="deleteAllHistory()">
          <i class="fas fa-trash-alt"></i> Delete All
        </button>
      </div>
      <div id="historyContent"></div>
    </div>
  </div>

  <!-- IT DAILY QUESTION SECTION -->
  <div class="glass-card">
    <h3><span class="section-icon"><i class="fas fa-question-circle"></i></span> IT Daily Question</h3>
    <div id="questionBox" class="questionBox" style="background: rgba(224,242,254,0.7); backdrop-filter: blur(8px); border-radius: 24px; padding: 1.5rem; border-left: 6px solid #10b981; margin-bottom: 1.5rem; font-size: 1.1rem; font-weight: 500; color: #065f46;">
      <i class="fas fa-spinner fa-spin"></i> Loading question...
    </div>
    <div class="input-icon-wrapper" style="margin-bottom: 1rem;">
      <i class="fas fa-pen-to-square"></i>
      <textarea id="todAnswer" placeholder="Write your answer here..."></textarea>
    </div>
    <div style="display: flex; justify-content: flex-end;">
      <button id="submitAnswerBtn" class="btn-success" onclick="saveAnswer()">
        <i class="fas fa-paper-plane"></i> Submit Answer
      </button>
    </div>
  </div>

  <!-- ACTIVITY SECTION -->
  <div id="activitySection" class="glass-card">
    <h3><span class="section-icon"><i class="fas fa-clock-rotate-left"></i></span> My Activity History</h3>
    
    <h4>Select Day</h4>
    <div class="day-buttons">
      <button class="btn-outline" onclick="loadDay('Monday')">Monday</button>
      <button class="btn-outline" onclick="loadDay('Tuesday')">Tuesday</button>
      <button class="btn-outline" onclick="loadDay('Wednesday')">Wednesday</button>
      <button class="btn-outline" onclick="loadDay('Thursday')">Thursday</button>
      <button class="btn-outline" onclick="loadDay('Friday')">Friday</button>
    </div>

    <div class="flex-wrap" style="margin-top: 1rem;">
      <button class="btn-primary" onclick="downloadPDF()">
        <i class="fas fa-file-pdf"></i> Download Selected Day PDF
      </button>
      <button class="btn-primary" onclick="downloadWeekPDF()">
        <i class="fas fa-file-pdf"></i> Download Full Week PDF
      </button>
    </div>

    <div id="activityTable" style="margin-top: 1.5rem;"></div>
  </div>
  
  <!-- LOGOUT BUTTON - BOTTOM (SECONDARY) -->
  <div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
    <button id="logoutBtnBottom" class="btn-outline btn-danger" style="border-width: 1.5px; padding: 0.7rem 2.2rem; border-color: #ef4444; color: #ef4444;">
      <i class="fas fa-sign-out-alt"></i> Logout
    </button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  deleteDoc,
  collection,
  query,
  where,
  getDocs,
  writeBatch
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBYOXnAQQWQNI9rFu0ZwMjNkMEdJH7SxxA",
  authDomain: "teacher-on-duty-system.firebaseapp.com",
  projectId: "teacher-on-duty-system",
  storageBucket: "teacher-on-duty-system.firebasestorage.app",
  messagingSenderId: "723640168531",
  appId: "1:723640168531:web:a52f5dac1f5502460016a6"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ================= DYNAMIC DATE FUNCTIONS (FIXED FOR CURRENT YEAR) ================= */

function getWeekDates(weekNum, year) {
  // Get the current year instead of hardcoding 2026
  const currentYear = year || new Date().getFullYear();
  
  // Find the first Monday of the current year
  const firstMonday = getFirstMondayOfYear(currentYear);
  
  // Calculate Monday of target week
  const targetMonday = new Date(firstMonday);
  targetMonday.setDate(firstMonday.getDate() + (weekNum - 1) * 7);
  
  const days = [];
  const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
  
  for (let i = 0; i < 5; i++) {
    const date = new Date(targetMonday);
    date.setDate(targetMonday.getDate() + i);
    days.push({
      name: dayNames[i],
      date: date,
      formatted: date.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      }),
      fullDate: date // Store the full date object
    });
  }
  
  return days;
}

function getFirstMondayOfYear(year) {
  // January 1st of the given year
  const janFirst = new Date(year, 0, 1);
  
  // Find the first Monday (day 1 = Monday)
  // If Jan 1 is Monday (1), then first Monday is Jan 1
  // If Jan 1 is Tuesday (2), then first Monday is Jan 7
  // If Jan 1 is Wednesday (3), then first Monday is Jan 6
  // If Jan 1 is Thursday (4), then first Monday is Jan 5
  // If Jan 1 is Friday (5), then first Monday is Jan 4
  // If Jan 1 is Saturday (6), then first Monday is Jan 3
  // If Jan 1 is Sunday (0), then first Monday is Jan 2
  
  const dayOfWeek = janFirst.getDay(); // 0 = Sunday, 1 = Monday, etc.
  
  // Calculate days to add to get to first Monday
  let daysToAdd;
  if (dayOfWeek === 1) { // Already Monday
    daysToAdd = 0;
  } else if (dayOfWeek === 0) { // Sunday
    daysToAdd = 1;
  } else { // Tuesday to Saturday
    daysToAdd = 8 - dayOfWeek;
  }
  
  const firstMonday = new Date(janFirst);
  firstMonday.setDate(janFirst.getDate() + daysToAdd);
  
  return firstMonday;
}

function getWeekNumber(date) {
  const year = date.getFullYear();
  const firstMonday = getFirstMondayOfYear(year);
  
  // If date is before first Monday of the year, it belongs to previous year
  if (date < firstMonday) {
    // Get last year's first Monday
    const lastYearFirstMonday = getFirstMondayOfYear(year - 1);
    const diffTime = date - lastYearFirstMonday;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return Math.floor(diffDays / 7) + 1;
  }
  
  const diffTime = date - firstMonday;
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  return Math.floor(diffDays / 7) + 1;
}

function getCurrentWeekNumber() {
  const today = new Date();
  return getWeekNumber(today);
}

function getCurrentYear() {
  return new Date().getFullYear();
}

// Test the dates with current year

console.log("‚úÖ TOD PAGE DATES FOR", currentYear);
console.log(`First Monday of ${currentYear}:`, getFirstMondayOfYear(currentYear).toDateString());
console.log("Current Week:", getCurrentWeekNumber());

// Test specific date
const testDate = new Date(); // Today's date
console.log(`Today (${testDate.toDateString()}) is Week:`, getWeekNumber(testDate));

// ---------- GLOBAL VARIABLES ----------
let isActiveWeek = false;
let canEditToday = false;
let currentUserTodId = null;
let assignedWeekNumber = null;
let assignedWeekData = null;
let currentWeek = getCurrentWeekNumber();
let currentYear = getCurrentYear(); // Dynamic current year
let currentUser = null;
let userData = null;
let userRole = null;
let assignedClasses = [];
let isAlsoCT = false;
let selectedDayData = null;
let autoSaveTimeout = null;

// ---------- SUPER VIEW SUPPORT ----------
let isSuperView = false;
let viewingUserId = null;
let viewingUserData = null;
let originalUserId = null;

function getUrlParams() {
  const params = new URLSearchParams(window.location.search);
  return {
    superId: params.get('superId'),
    superToken: params.get('superToken')
  };
}

// ---------- DATE SETUP ----------
let today = new Date();
let todayISO = today.toISOString().split("T")[0];
let dayName = today.toLocaleDateString("en-US", { weekday: "long" });
let dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, etc.

document.getElementById("todayHeader").innerHTML = `
  <i class="fas fa-calendar-check" style="margin-right: 0.5rem;"></i>
  ${dayName} - ${todayISO} (Week ${currentWeek})
`;

// Show Sunday message if today is Sunday
if (dayOfWeek === 0) {
  document.getElementById('sundayMessage').style.display = 'block';
}

// ---------- CLASS LIST ----------
let classes = [
  "Prep 1", "Prep 2",
  "Class 1", "Class 2", "Class 3",
  "Class 4", "Class 5", "Class 6", "Class 7"
];

// ==================== AUTH STATE WITH SUPER SUPPORT ====================
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }
  
  currentUser = user;
  
  // Check for super user parameters
  const params = getUrlParams();
  
  if (params.superId && params.superToken) {
    // Verify the super token
    const superUserDoc = await getDoc(doc(db, "users", params.superToken));
    if (superUserDoc.exists() && (superUserDoc.data().role === "IT" || superUserDoc.data().role === "SUPER")) {
      // Valid super user access
      const targetUserDoc = await getDoc(doc(db, "users", params.superId));
      if (targetUserDoc.exists()) {
        isSuperView = true;
        viewingUserId = params.superId;
        viewingUserData = targetUserDoc.data();
        originalUserId = user.uid;
        
        // Show super user info
        const superInfo = document.createElement('div');
        superInfo.className = 'super-user-info';
        superInfo.innerHTML = `
          <div style="background: rgba(139,92,246,0.1); border: 2px solid #8b5cf6; border-radius: 40px; padding: 1rem; margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem;">
              <i class="fas fa-crown" style="color: #8b5cf6; font-size: 1.5rem;"></i>
              <span style="color: #7c3aed; font-weight: 600;">Super User Viewing Mode</span>
              <span>Viewing as: <strong>${viewingUserData.name || viewingUserData.email}</strong> (${viewingUserData.role})</span>
            </div>
            <button class="btn-small" style="background: #8b5cf6; color: white; border: none;" onclick="returnToOwnDashboard()">
              <i class="fas fa-undo"></i> Return
            </button>
          </div>
        `;
        document.querySelector('.dashboard-container').insertBefore(superInfo, document.querySelector('.glass-card'));
      }
    }
  }
  
  // Get the appropriate user data (either real user or viewing user)
  const targetUserId = isSuperView ? viewingUserId : user.uid;
  const userDoc = await getDoc(doc(db, "users", targetUserId));
  
  if (!userDoc.exists() || (userDoc.data().role !== "TOD" && userDoc.data().role !== "CT" && !isSuperView)) {
    if (!isSuperView) {
      alert("Access Denied: Teacher On Duty only");
      window.location.href = "index.html";
      return;
    }
  }
  
  userData = userDoc.data();
  userRole = userData.role;
  assignedClasses = userData.assignedClasses || [];
  isAlsoCT = userData.isAlsoCT || false;
  
  // Update user name display
  const displayName = userData.name || userData.email || user.email;
  document.getElementById("userNameText").innerText = displayName;
  
  // Update role badge for SUPER view
  if (isSuperView) {
    document.getElementById("roleBadge").classList.add("super-badge");
    document.getElementById("roleText").innerText = `${userRole} (Super View)`;
  } else {
    document.getElementById("roleText").innerText = userRole;
  }
  
  document.getElementById("classCount").innerText = assignedClasses.length ? `${assignedClasses.length} Classes` : '';
  
  // Show/hide CT tab
  document.getElementById("tabCT").style.display = (userRole === "CT" || isAlsoCT) ? "block" : "none";
  document.getElementById("tabHistory").style.display = "block";
  
  await checkActiveWeek();
  createTable(canEditToday);
  createCTCards();
  await loadRegistrationData();
  await loadSavedAttendance();
  await loadQuestion();
  calculateGrandTotals();
});

// Return to own dashboard
window.returnToOwnDashboard = function() {
  window.location.href = "dashboard.html";
};

// ---------- FIND WHICH WEEK THE TOD IS ASSIGNED TO (UPDATED for SUPER view) ----------
async function findAssignedWeek(userId = null) {
  try {
    const targetId = userId || (isSuperView ? viewingUserId : currentUser?.uid);
    if (!targetId) return null;
    
    // Get all duty plans
    const dutyPlansSnap = await getDocs(collection(db, "dutyPlan"));
    let assignedWeek = null;
    
    dutyPlansSnap.forEach(doc => {
      const data = doc.data();
      if (data.todId === targetId) {
        assignedWeek = data.weekNumber;
      }
    });
    
    return assignedWeek;
  } catch (error) {
    console.error("Error finding assigned week:", error);
    return null;
  }
}

// ---------- CHECK IF USER CAN EDIT TODAY ----------
function canEditTodayCheck(assignedWeek) {
  // If not assigned to any week
  if (!assignedWeek) return false;
  
  // If not assigned to current week
  if (assignedWeek !== currentWeek) return false;
  
  // If today is Sunday, cannot edit (week starts Monday)
  if (dayOfWeek === 0) return false;
  
  // All checks passed - can edit
  return true;
}

// ---------- CHECK IF CURRENT WEEK IS USER'S ACTIVE WEEK (UPDATED for SUPER view) ----------
async function checkActiveWeek() {
  try {
    const user = auth.currentUser;
    if (!user) return false;
    
    // If in SUPER view, use the viewing user ID instead of current user
    const targetUserId = isSuperView ? viewingUserId : user.uid;
    
    const userDoc = await getDoc(doc(db, "users", targetUserId));
    if (!userDoc.exists()) return false;
    
    currentUserTodId = targetUserId;
    
    // Find which week this TOD is assigned to
    assignedWeekNumber = await findAssignedWeek(targetUserId);
    
    // Check if they're assigned to current week
    isActiveWeek = (assignedWeekNumber === currentWeek);
    
    // Check if they can edit TODAY specifically
    canEditToday = canEditTodayCheck(assignedWeekNumber);
    
    // Update UI
    updateWeekUI();
    
    return canEditToday;
  } catch (error) {
    console.error("Error checking active week:", error);
    return false;
  }
}

// ---------- UPDATE UI WITH BEAUTIFUL CALENDAR ----------
function updateWeekUI() {
  const calendarDiv = document.getElementById('assignedWeekCalendar');
  const saveBtn = document.getElementById('saveAttendanceBtn');
  const submitAnswerBtn = document.getElementById('submitAnswerBtn');
  
  let calendarHtml = '';
  
  if (assignedWeekNumber) {
    // Show the week they're assigned to
    const weekDates = getWeekDates(assignedWeekNumber, currentYear);
    const isCurrent = (assignedWeekNumber === currentWeek);
    
    let datesHtml = '';
    weekDates.forEach(day => {
      datesHtml += `
        <div class="date-chip">
          <span class="day">${day.name}:</span>
          <span class="date">${day.formatted}</span>
        </div>
      `;
    });
    
    let statusMessage = '';
    if (isCurrent && dayOfWeek === 0) {
      statusMessage = '<span class="not-assigned-badge" style="background: #f59e0b;">‚è≥ Starts Tomorrow</span>';
    } else if (isCurrent && canEditToday) {
      statusMessage = '<span class="assigned-badge">‚úì Your Active Week</span>';
    } else if (isCurrent && !canEditToday) {
      statusMessage = '<span class="not-assigned-badge">‚úó Cannot Edit Today</span>';
    } else if (assignedWeekNumber > currentWeek) {
      statusMessage = `<span class="not-assigned-badge">‚úó Your Week ${assignedWeekNumber} (Future)</span>`;
    } else if (assignedWeekNumber < currentWeek) {
      statusMessage = `<span class="not-assigned-badge">‚úó Your Week ${assignedWeekNumber} (Past)</span>`;
    }
    
    calendarHtml = `
      <div class="week-row ${isCurrent ? 'current-week' : ''}">
        <div class="week-number">
          <i class="fas fa-calendar-week"></i> Week ${assignedWeekNumber}
          ${isCurrent ? '<span class="assigned-badge" style="margin-left: 0.5rem;">Current</span>' : ''}
        </div>
        <div class="week-dates">
          ${datesHtml}
        </div>
        <div>
          ${statusMessage}
        </div>
      </div>
    `;
  } else {
    // No assignment found - show current week
    const weekDates = getWeekDates(currentWeek, currentYear);
    let datesHtml = '';
    weekDates.forEach(day => {
      datesHtml += `
        <div class="date-chip">
          <span class="day">${day.name}:</span>
          <span class="date">${day.formatted}</span>
        </div>
      `;
    });
    
    calendarHtml = `
      <div class="week-row">
        <div class="week-number">
          <i class="fas fa-calendar-week"></i> Current Week ${currentWeek}
        </div>
        <div class="week-dates">
          ${datesHtml}
        </div>
        <div>
          <span class="not-assigned-badge">‚úó Not Assigned Yet</span>
        </div>
      </div>
    `;
  }
  
  calendarDiv.innerHTML = calendarHtml;
  
  // Enable/disable buttons based on canEditToday
  if (canEditToday) {
    if (saveBtn) {
      saveBtn.disabled = false;
      saveBtn.style.opacity = '1';
      saveBtn.style.cursor = 'pointer';
    }
    if (submitAnswerBtn) {
      submitAnswerBtn.disabled = false;
      submitAnswerBtn.style.opacity = '1';
      submitAnswerBtn.style.cursor = 'pointer';
    }
  } else {
    if (saveBtn) {
      saveBtn.disabled = true;
      saveBtn.style.opacity = '0.5';
      saveBtn.style.cursor = 'not-allowed';
    }
    if (submitAnswerBtn) {
      submitAnswerBtn.disabled = true;
      submitAnswerBtn.style.opacity = '0.5';
      submitAnswerBtn.style.cursor = 'not-allowed';
    }
  }
}

// ---------- CREATE TABLE ----------
function createTable(isEditable = false) {
  let html = `<div class="table-responsive"><table>
    <thead>
      <tr>
        <th rowspan="2">Class</th>
        <th colspan="3">Registered</th>
        <th colspan="3">Present</th>
        <th colspan="3">Absent</th>
        <th colspan="3">Sick</th>
        <th colspan="3">Permission</th>
      </tr>
      <tr>
        ${["B","G","T","B","G","T","B","G","T","B","G","T","B","G","T"]
          .map(h => `<th>${h}</th>`).join("")}
      </tr>
    </thead>
    <tbody>`;
  
  classes.forEach(c => {
    const preReadonly = isEditable ? '' : 'readonly';
    const absReadonly = isEditable ? '' : 'readonly';
    const sickReadonly = isEditable ? '' : 'readonly';
    const perReadonly = isEditable ? '' : 'readonly';
    
    html += `
      <tr>
        <td><strong>${c}</strong></td>
        <td><input id="regB_${c}" readonly></td>
        <td><input id="regG_${c}" readonly></td>
        <td><input id="regT_${c}" readonly></td>
        
        <td><input id="preB_${c}" oninput="calcRow('${c}')" min="0" ${preReadonly}></td>
        <td><input id="preG_${c}" oninput="calcRow('${c}')" min="0" ${preReadonly}></td>
        <td><input id="preT_${c}" readonly></td>
        
        <td><input id="absB_${c}" oninput="calcRow('${c}')" min="0" ${absReadonly}></td>
        <td><input id="absG_${c}" oninput="calcRow('${c}')" min="0" ${absReadonly}></td>
        <td><input id="absT_${c}" readonly></td>
        
        <td><input id="sickB_${c}" oninput="calcRow('${c}')" min="0" ${sickReadonly}></td>
        <td><input id="sickG_${c}" oninput="calcRow('${c}')" min="0" ${sickReadonly}></td>
        <td><input id="sickT_${c}" readonly></td>
        
        <td><input id="perB_${c}" oninput="calcRow('${c}')" min="0" ${perReadonly}></td>
        <td><input id="perG_${c}" oninput="calcRow('${c}')" min="0" ${perReadonly}></td>
        <td><input id="perT_${c}" readonly></td>
      </tr>
    `;
  });

  html += `
    <tr class="totalRow">
      <td><strong>Total</strong></td>
      ${Array(15).fill('<td class="grandTotal">0</td>').join("")}
    </tr>
    </tbody></table></div>`;

  document.getElementById("attendanceTable").innerHTML = html;
  
  if (isEditable) {
    document.querySelectorAll('.preB, .preG, .absB, .absG, .sickB, .sickG, .perB, .perG').forEach(input => {
      input.addEventListener('input', function() {
        const classId = this.id.split('_')[1];
        calcRow(classId);
      });
    });
  }
}

// ==================== CT SECTION WITH STUDENT NAMES (UPDATED for persistence) ====================
function createCTCards() {
  const container = document.getElementById("classCardsContainer");
  if (assignedClasses.length === 0) {
    container.innerHTML = '<div class="empty-state">No classes assigned</div>';
    return;
  }
  
  let html = '';
  assignedClasses.forEach(cls => {
    const safeCls = cls.replace(/\s/g, '_');
    html += `
      <div class="class-card" id="card_${safeCls}">
        <div class="class-header">
          <span class="class-name">${cls}</span>
          <span class="badge badge-success">CT</span>
        </div>
        
        <div class="student-list" id="students_${safeCls}">
          <div style="text-align:center; color:#6b8ca3;"><i class="fas fa-spinner fa-spin"></i> Loading students...</div>
        </div>
        
        <div class="add-student-form">
          <input type="text" id="newStudentName_${safeCls}" placeholder="Student name">
          <select id="newStudentGender_${safeCls}">
            <option value="boy">üë¶ Boy</option>
            <option value="girl">üëß Girl</option>
          </select>
          <button class="btn-small btn-success" onclick="addStudent('${cls}')"><i class="fas fa-plus"></i> Add</button>
        </div>
      </div>
    `;
  });
  container.innerHTML = html;
  assignedClasses.forEach(cls => loadStudents(cls));
}

// Load students for a class - UPDATED to handle date-specific attendance
async function loadStudents(cls) {
  const safeCls = cls.replace(/\s/g, '_');
  const studentList = document.getElementById(`students_${safeCls}`);
  
  const studentsSnap = await getDocs(query(
    collection(db, "students"), 
    where("class", "==", cls),
    where("schoolYear", "==", currentYear.toString())
  ));
  
  if (studentsSnap.empty) {
    studentList.innerHTML = '<div style="text-align:center; color:#6b8ca3; padding:1rem;">No students added yet</div>';
    return;
  }
  
  let html = '';
  for (const studentDoc of studentsSnap.docs) {
    const student = studentDoc.data();
    const genderClass = student.gender === 'boy' ? 'boys' : 'girls';
    
    // Get today's attendance status for this student
    // This creates a new record each day automatically
    const statusDoc = await getDoc(doc(db, "attendance", todayISO, "students", studentDoc.id));
    
    // If no record exists for today, create one with default 'absent'
    let todayStatus = 'absent';
    if (statusDoc.exists()) {
      todayStatus = statusDoc.data().status;
    } else {
      // Create default attendance record for today
      await setDoc(doc(db, "attendance", todayISO, "students", studentDoc.id), {
        status: 'absent',
        studentId: studentDoc.id,
        studentName: student.name,
        class: cls,
        date: todayISO,
        createdAt: new Date()
      });
    }
    
    html += `
      <div class="student-item ${genderClass}" id="student_${studentDoc.id}">
        <div class="student-info">
          <span class="student-name">${student.name}</span>
          <span class="student-gender ${genderClass}">${student.gender === 'boy' ? 'üë¶ Boy' : 'üëß Girl'}</span>
        </div>
        <div class="attendance-status">
          <button class="status-btn present ${todayStatus === 'present' ? 'active' : ''}" onclick="setStudentStatus('${studentDoc.id}', 'present')">P</button>
          <button class="status-btn absent ${todayStatus === 'absent' ? 'active' : ''}" onclick="setStudentStatus('${studentDoc.id}', 'absent')">A</button>
          <button class="status-btn sick ${todayStatus === 'sick' ? 'active' : ''}" onclick="setStudentStatus('${studentDoc.id}', 'sick')">S</button>
          <button class="status-btn permission ${todayStatus === 'permission' ? 'active' : ''}" onclick="setStudentStatus('${studentDoc.id}', 'permission')">Pm</button>
        </div>
        <button class="btn-small btn-danger" onclick="deleteStudent('${studentDoc.id}')"><i class="fas fa-trash"></i></button>
      </div>
    `;
  }
  studentList.innerHTML = html;
}

// Add new student
window.addStudent = async function(cls) {
  const safeCls = cls.replace(/\s/g, '_');
  const nameInput = document.getElementById(`newStudentName_${safeCls}`);
  const genderSelect = document.getElementById(`newStudentGender_${safeCls}`);
  const name = nameInput.value.trim();
  const gender = genderSelect.value;
  
  if (!name) { alert("Enter student name"); return; }
  
  try {
    // Save student to permanent collection
    const studentRef = doc(collection(db, "students"));
    await setDoc(studentRef, {
      name,
      gender,
      class: cls,
      schoolYear: currentYear.toString(),
      createdAt: new Date(),
      createdBy: currentUser.email
    });
    
    nameInput.value = '';
    await loadStudents(cls);
    await updateClassCountsFromStudents();
    showAutoSaveIndicator("Student added");
  } catch (error) {
    console.error("Error adding student:", error);
    alert("Error adding student: " + error.message);
  }
};

// Set student attendance status - UPDATED to ensure it saves per day
window.setStudentStatus = async function(studentId, status) {
  try {
    // Save to date-specific subcollection
    await setDoc(doc(db, "attendance", todayISO, "students", studentId), {
      status,
      studentId: studentId,
      date: todayISO,
      updatedAt: new Date(),
      updatedBy: currentUser?.email || 'system'
    });
    
    // Update UI
    const studentDiv = document.getElementById(`student_${studentId}`);
    if (studentDiv) {
      studentDiv.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
      const activeBtn = studentDiv.querySelector(`.status-btn.${status}`);
      if (activeBtn) activeBtn.classList.add('active');
    }
    
    await updateClassCountsFromStudents();
    showAutoSaveIndicator("Saved");
  } catch (error) {
    console.error("Error setting status:", error);
    alert("Error saving status: " + error.message);
  }
};

// Delete student
window.deleteStudent = async function(studentId) {
  if (confirm("Delete this student?")) {
    try {
      await deleteDoc(doc(db, "students", studentId));
      
      // Also delete all attendance records for this student across all dates
      const attendanceQuery = query(collection(db, "attendance"), where("studentId", "==", studentId));
      const attendanceSnap = await getDocs(attendanceQuery);
      attendanceSnap.forEach(async (doc) => {
        await deleteDoc(doc.ref);
      });
      
      await loadStudentsForAllClasses();
      await updateClassCountsFromStudents();
      showAutoSaveIndicator("Student deleted");
    } catch (error) {
      console.error("Error deleting student:", error);
      alert("Error deleting student: " + error.message);
    }
  }
};

// Load students for all classes
async function loadStudentsForAllClasses() {
  for (const cls of assignedClasses) {
    await loadStudents(cls);
  }
}

// Update class counts based on student attendance
async function updateClassCountsFromStudents() {
  const studentsSnap = await getDocs(query(
    collection(db, "students"), 
    where("schoolYear", "==", currentYear.toString())
  ));
  
  const counts = {};
  classes.forEach(cls => {
    counts[cls] = { present: 0, absent: 0, sick: 0, permission: 0, boys: 0, girls: 0 };
  });
  
  for (const studentDoc of studentsSnap.docs) {
    const student = studentDoc.data();
    
    // Count by gender
    if (student.gender === 'boy') counts[student.class].boys++;
    else counts[student.class].girls++;
    
    // Get today's status
    const statusDoc = await getDoc(doc(db, "attendance", todayISO, "students", studentDoc.id));
    const status = statusDoc.exists() ? statusDoc.data().status : 'absent';
    
    if (status === 'present') counts[student.class].present++;
    else if (status === 'absent') counts[student.class].absent++;
    else if (status === 'sick') counts[student.class].sick++;
    else if (status === 'permission') counts[student.class].permission++;
  }
  
  // Update TOD table
  classes.forEach(cls => {
    const totalBoys = counts[cls].boys;
    const totalGirls = counts[cls].girls;
    const totalStudents = totalBoys + totalGirls;
    
    const presentTotal = counts[cls].present;
    const absentTotal = counts[cls].absent;
    const sickTotal = counts[cls].sick;
    const permTotal = counts[cls].permission;
    
    if (totalStudents > 0) {
      const boyRatio = totalBoys / totalStudents;
      const girlRatio = totalGirls / totalStudents;
      
      setValue(`preB_${cls}`, Math.round(presentTotal * boyRatio));
      setValue(`preG_${cls}`, Math.round(presentTotal * girlRatio));
      setValue(`absB_${cls}`, Math.round(absentTotal * boyRatio));
      setValue(`absG_${cls}`, Math.round(absentTotal * girlRatio));
      setValue(`sickB_${cls}`, Math.round(sickTotal * boyRatio));
      setValue(`sickG_${cls}`, Math.round(sickTotal * girlRatio));
      setValue(`perB_${cls}`, Math.round(permTotal * boyRatio));
      setValue(`perG_${cls}`, Math.round(permTotal * girlRatio));
      
      calcRow(cls);
    }
  });
}

function setValue(id, value) {
  const el = document.getElementById(id);
  if (el) el.value = value || 0;
}

// ==================== HISTORY SECTION ====================
window.loadFullHistory = async function() {
  const content = document.getElementById("historyContent");
  const currentMonth = new Date().toISOString().slice(0, 7);
  document.getElementById("historyMonth").value = currentMonth;
  
  const attendanceSnap = await getDocs(collection(db, "attendance"));
  const months = {};
  
  attendanceSnap.forEach(doc => {
    const date = doc.id;
    const month = date.slice(0, 7);
    if (!months[month]) months[month] = [];
    months[month].push(doc.data());
  });
  
  let html = '<div class="year-grid">';
  Object.keys(months).sort().reverse().forEach(month => {
    const [year, monthNum] = month.split('-');
    const monthName = new Date(year, monthNum-1, 1).toLocaleString('default', { month: 'long' });
    html += `
      <div class="month-card" onclick="loadMonthHistory('${month}')">
        <div class="month-name">${monthName} ${year}</div>
        <div class="month-count">${months[month].length} days</div>
      </div>
    `;
  });
  
  if (Object.keys(months).length === 0) {
    html += '<div class="empty-state">No attendance history found</div>';
  }
  
  html += '</div>';
  content.innerHTML = html;
};

window.loadMonthHistory = async function(month) {
  const monthValue = month || document.getElementById("historyMonth").value;
  if (!monthValue) return;
  
  const [year, monthNum] = monthValue.split('-');
  const startDate = `${year}-${monthNum}-01`;
  const endDate = `${year}-${monthNum}-31`;
  
  const q = query(
    collection(db, "attendance"),
    where("date", ">=", startDate),
    where("date", "<=", endDate)
  );
  
  const snap = await getDocs(q);
  let html = '<div class="history-table">';
  
  if (snap.empty) {
    html += '<div class="empty-state">No records for this month</div>';
  } else {
    snap.forEach(doc => {
      const data = doc.data();
      const totalReg = data.data?.reduce((sum, cls) => sum + (parseInt(cls.regB) || 0) + (parseInt(cls.regG) || 0), 0) || 0;
      const totalPre = data.data?.reduce((sum, cls) => sum + (parseInt(cls.preB) || 0) + (parseInt(cls.preG) || 0), 0) || 0;
      const percentage = totalReg > 0 ? Math.round((totalPre / totalReg) * 100) : 0;
      
      html += `
        <div class="history-row">
          <div>
            <div class="history-date">${data.day || 'Unknown'} - ${doc.id}</div>
            <div class="history-stats">
              <span class="badge">Present: ${totalPre}/${totalReg} (${percentage}%)</span>
              ${data.todName ? `<span class="badge">TOD: ${data.todName}</span>` : ''}
            </div>
          </div>
          <div class="history-actions">
            <button class="btn-small btn-primary" onclick="viewHistoryDay('${doc.id}')"><i class="fas fa-eye"></i> View</button>
            <button class="btn-small btn-danger" onclick="deleteHistoryDay('${doc.id}')"><i class="fas fa-trash"></i> Delete</button>
          </div>
        </div>
      `;
    });
  }
  
  html += '</div>';
  document.getElementById("historyContent").innerHTML = html;
};

window.viewHistoryDay = async function(date) {
  const snap = await getDoc(doc(db, "attendance", date));
  if (!snap.exists()) return;
  
  const data = snap.data();
  let html = `
    <div style="margin-bottom:1rem;">
      <button class="btn-outline btn-small" onclick="loadMonthHistory()"><i class="fas fa-arrow-left"></i> Back</button>
    </div>
    <h3>${data.day || 'Unknown'} - ${date}</h3>
  `;
  
  if (data.data && data.data.length > 0) {
    html += '<div class="table-responsive"><table><thead><tr><th>Class</th><th>Reg B</th><th>Reg G</th><th>Pre B</th><th>Pre G</th><th>Abs B</th><th>Abs G</th><th>Sick B</th><th>Sick G</th><th>Perm B</th><th>Perm G</th></tr></thead><tbody>';
    
    data.data.forEach(cls => {
      html += `<tr>
        <td>${cls.class}</td>
        <td>${cls.regB || 0}</td>
        <td>${cls.regG || 0}</td>
        <td>${cls.preB || 0}</td>
        <td>${cls.preG || 0}</td>
        <td>${cls.absB || 0}</td>
        <td>${cls.absG || 0}</td>
        <td>${cls.sickB || 0}</td>
        <td>${cls.sickG || 0}</td>
        <td>${cls.perB || 0}</td>
        <td>${cls.perG || 0}</td>
      </tr>`;
    });
    
    html += '</tbody></table></div>';
  }
  
  if (data.todAnswer) {
    html += `<div style="margin-top:1rem; padding:1rem; background:rgba(16,185,129,0.05); border-radius:20px;">
      <strong>TOD Answer:</strong> ${data.todAnswer}
    </div>`;
  }
  
  if (data.htAnswer) {
    html += `<div style="margin-top:0.5rem; padding:1rem; background:rgba(10,102,194,0.05); border-radius:20px;">
      <strong>HT Response:</strong> ${data.htAnswer}
    </div>`;
  }
  
  document.getElementById("historyContent").innerHTML = html;
};

window.deleteHistoryDay = async function(date) {
  if (confirm(`Delete attendance for ${date}?`)) {
    try {
      await deleteDoc(doc(db, "attendance", date));
      alert("‚úÖ Deleted");
      loadMonthHistory();
    } catch (error) {
      alert("Error deleting: " + error.message);
    }
  }
};

window.deleteAllHistory = async function() {
  if (!confirm("‚ö†Ô∏è Delete ALL attendance history? This cannot be undone!")) return;
  if (!confirm("Are you absolutely sure?")) return;
  
  try {
    const snap = await getDocs(collection(db, "attendance"));
    const batch = writeBatch(db);
    snap.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
    alert("‚úÖ All history deleted");
    loadFullHistory();
  } catch (error) {
    alert("Error deleting: " + error.message);
  }
};

// ---------- LOAD REGISTRATION DATA FROM SYSTEM ----------
async function loadRegistrationData() {
  try {
    const regSnap = await getDoc(doc(db, "system", "classRegistration"));
    if (regSnap.exists()) {
      const data = regSnap.data().classes;
      if (data && data.length) {
        data.forEach(item => {
          const regB = document.getElementById(`regB_${item.class}`);
          const regG = document.getElementById(`regG_${item.class}`);
          const regT = document.getElementById(`regT_${item.class}`);
          if (regB && regG && regT) {
            regB.value = item.regB || 0;
            regG.value = item.regG || 0;
            regT.value = (item.regB || 0) + (item.regG || 0);
          }
        });
      }
    }
  } catch (e) {
    console.error("Error loading registration data:", e);
  }
}

// ---------- CALCULATE ROW TOTALS ----------
window.calcRow = function(c) {
  function sum(bId, gId, tId) {
    let b = Number(document.getElementById(bId)?.value) || 0;
    let g = Number(document.getElementById(gId)?.value) || 0;
    let tEl = document.getElementById(tId);
    if (tEl) tEl.value = b + g;
  }
  sum(`preB_${c}`, `preG_${c}`, `preT_${c}`);
  sum(`absB_${c}`, `absG_${c}`, `absT_${c}`);
  sum(`sickB_${c}`, `sickG_${c}`, `sickT_${c}`);
  sum(`perB_${c}`, `perG_${c}`, `perT_${c}`);
  calculateGrandTotals();
};

// ---------- CALCULATE GRAND TOTALS & PERCENTAGE ----------
window.calculateGrandTotals = function() {
  const totals = Array(15).fill(0);
  classes.forEach(c => {
    [
      `regB_${c}`, `regG_${c}`, `regT_${c}`,
      `preB_${c}`, `preG_${c}`, `preT_${c}`,
      `absB_${c}`, `absG_${c}`, `absT_${c}`,
      `sickB_${c}`, `sickG_${c}`, `sickT_${c}`,
      `perB_${c}`, `perG_${c}`, `perT_${c}`
    ].forEach((id, i) => {
      let el = document.getElementById(id);
      if (el) totals[i] += Number(el.value) || 0;
    });
  });
  document.querySelectorAll(".grandTotal").forEach((cell, i) => {
    cell.innerText = totals[i];
  });
  
  const totalRegistered = totals[2];
  const totalPresent = totals[5];
  let percentage = 0;
  if (totalRegistered > 0) {
    percentage = Math.round((totalPresent / totalRegistered) * 100);
  }
  const percentageElement = document.getElementById("presentPercentageValue");
  if (percentageElement) {
    percentageElement.innerText = `${percentage}%`;
    if (percentage >= 90) percentageElement.style.color = "#10b981";
    else if (percentage >= 75) percentageElement.style.color = "#f59e0b";
    else percentageElement.style.color = "#ef4444";
  }
};

// ---------- SAVE ATTENDANCE ----------
window.saveAttendance = async () => {
  if (!canEditToday) {
    alert("You can only save attendance during your assigned week (Monday-Friday)!");
    return;
  }
  
  const user = auth.currentUser;
  if (!user) { alert("Login required"); return; }
  
  let data = [];
  classes.forEach(c => {
    data.push({
      class: c,
      regB: document.getElementById(`regB_${c}`)?.value || 0,
      regG: document.getElementById(`regG_${c}`)?.value || 0,
      preB: document.getElementById(`preB_${c}`)?.value || 0,
      preG: document.getElementById(`preG_${c}`)?.value || 0,
      absB: document.getElementById(`absB_${c}`)?.value || 0,
      absG: document.getElementById(`absG_${c}`)?.value || 0,
      sickB: document.getElementById(`sickB_${c}`)?.value || 0,
      sickG: document.getElementById(`sickG_${c}`)?.value || 0,
      perB: document.getElementById(`perB_${c}`)?.value || 0,
      perG: document.getElementById(`perG_${c}`)?.value || 0
    });
  });
  
  const existingSnap = await getDoc(doc(db, "attendance", todayISO));
  const existingData = existingSnap.exists() ? existingSnap.data() : {};
  
  await setDoc(doc(db, "attendance", todayISO), {
    date: todayISO, 
    day: dayName, 
    weekNumber: currentWeek,
    todId: currentUserTodId,
    todName: isSuperView ? viewingUserData?.email : user.email,
    todDisplayName: isSuperView ? (viewingUserData?.name || viewingUserData?.email) : (user.displayName || user.email), 
    data: data, 
    todAnswer: existingData.todAnswer || "",
    htAnswer: existingData.htAnswer || "",
    savedAt: new Date()
  });
  alert("‚úÖ Attendance Saved");
};

// ---------- LOAD SAVED ATTENDANCE ----------
async function loadSavedAttendance() {
  const snap = await getDoc(doc(db, "attendance", todayISO));
  if (snap.exists()) {
    const data = snap.data().data;
    const todAnswer = snap.data().todAnswer || "";
    
    const answerTextarea = document.getElementById("todAnswer");
    if (answerTextarea && todAnswer) {
      answerTextarea.value = todAnswer;
    }
    
    if (data) {
      data.forEach(item => {
        const preB = document.getElementById(`preB_${item.class}`);
        const preG = document.getElementById(`preG_${item.class}`);
        const absB = document.getElementById(`absB_${item.class}`);
        const absG = document.getElementById(`absG_${item.class}`);
        const sickB = document.getElementById(`sickB_${item.class}`);
        const sickG = document.getElementById(`sickG_${item.class}`);
        const perB = document.getElementById(`perB_${item.class}`);
        const perG = document.getElementById(`perG_${item.class}`);
        if (preB) preB.value = item.preB || 0;
        if (preG) preG.value = item.preG || 0;
        if (absB) absB.value = item.absB || 0;
        if (absG) absG.value = item.absG || 0;
        if (sickB) sickB.value = item.sickB || 0;
        if (sickG) sickG.value = item.sickG || 0;
        if (perB) perB.value = item.perB || 0;
        if (perG) perG.value = item.perG || 0;
        window.calcRow(item.class);
      });
    }
    calculateGrandTotals();
  }
  
  await loadRegistrationData();
}

// ---------- LOAD QUESTION ----------
async function loadQuestion() {
  const snap = await getDoc(doc(db, "questions", "daily"));
  if (!snap.exists() || !snap.data().tod) {
    document.getElementById("questionBox").innerHTML = `<i class="fas fa-info-circle"></i> No question posted by IT`;
    return;
  }
  document.getElementById("questionBox").innerHTML = snap.data().tod;
}

// ---------- SAVE ANSWER ----------
window.saveAnswer = async () => {
  if (!canEditToday) {
    alert("You can only submit answers during your assigned week (Monday-Friday)!");
    return;
  }
  
  const user = auth.currentUser;
  let answer = document.getElementById("todAnswer").value.trim();
  if (!answer) { alert("Please write an answer"); return; }
  
  await setDoc(doc(db, "attendance", todayISO), {
    todAnswer: answer,
    answer: answer,
    submittedAt: new Date()
  }, { merge: true });
  
  alert("‚úÖ Answer Submitted - Visible to Head Teacher");
};

// ---------- TAB SWITCHING ----------
window.switchTab = function(tab) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById(`tab${tab.toUpperCase()}`).classList.add('active');
  document.getElementById('todSection').style.display = tab === 'tod' ? 'block' : 'none';
  document.getElementById('ctSection').style.display = tab === 'ct' ? 'block' : 'none';
  document.getElementById('historySection').style.display = tab === 'history' ? 'block' : 'none';
  if (tab === 'history') loadFullHistory();
  if (tab === 'ct') loadCTAttendance();
};

// ---------- SHOW ACTIVITY ----------
window.showActivity = function() {
  document.getElementById("activitySection").style.display = "block";
  document.getElementById("activitySection").scrollIntoView({ behavior: 'smooth' });
};

// ---------- LOAD DAY FOR ACTIVITY ----------
window.loadDay = async function(day) {
  const user = auth.currentUser;
  const q = query(
    collection(db, "attendance"),
    where("todName", "==", isSuperView ? viewingUserData?.email : user.email),
    where("day", "==", day)
  );
  const snap = await getDocs(q);
  let html = "";
  selectedDayData = null;

  if (snap.empty) {
    html = `<div class="empty-state"><i class="fas fa-info-circle"></i> No records found for ${day}</div>`;
  } else {
    snap.forEach(d => {
      let data = d.data();
      selectedDayData = data;
      
      let totalRegB = 0, totalRegG = 0, totalRegT = 0;
      let totalPreB = 0, totalPreG = 0, totalPreT = 0;
      let totalAbsB = 0, totalAbsG = 0, totalAbsT = 0;
      let totalSickB = 0, totalSickG = 0, totalSickT = 0;
      let totalPerB = 0, totalPerG = 0, totalPerT = 0;
      
      data.data.forEach(r => {
        totalRegB += parseInt(r.regB) || 0;
        totalRegG += parseInt(r.regG) || 0;
        totalPreB += parseInt(r.preB) || 0;
        totalPreG += parseInt(r.preG) || 0;
        totalAbsB += parseInt(r.absB) || 0;
        totalAbsG += parseInt(r.absG) || 0;
        totalSickB += parseInt(r.sickB) || 0;
        totalSickG += parseInt(r.sickG) || 0;
        totalPerB += parseInt(r.perB) || 0;
        totalPerG += parseInt(r.perG) || 0;
      });
      
      totalRegT = totalRegB + totalRegG;
      totalPreT = totalPreB + totalPreG;
      totalAbsT = totalAbsB + totalAbsG;
      totalSickT = totalSickB + totalSickG;
      totalPerT = totalPerB + totalPerG;
      
      let presentPercentage = 0;
      if (totalRegT > 0) {
        presentPercentage = Math.round((totalPreT / totalRegT) * 100);
      }
      
      html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h4><i class="fas fa-calendar-day"></i> ${data.day} - ${data.date} (Week ${data.weekNumber || '?'})</h4>
        <span class="percentage-badge" style="background: rgba(16,185,129,0.15);">
          <i class="fas fa-chart-line"></i> Present Rate: 
          <span style="background: white; padding: 0.2rem 0.8rem; border-radius: 30px; font-weight: 800; color: ${presentPercentage >= 90 ? '#10b981' : presentPercentage >= 75 ? '#f59e0b' : '#ef4444'};">
            ${presentPercentage}%
          </span>
        </span>
      </div>`;
      
      html += `<div style="margin-bottom: 1.5rem;">
        <h5 style="display: flex; align-items: center; gap: 0.5rem; color: #065f46; margin-bottom: 0.5rem;">
          <i class="fas fa-comment-dots" style="color: #10b981;"></i> Your Answer:
        </h5>
        <div style="background: rgba(16,185,129,0.05); backdrop-filter: blur(8px); border-radius: 20px; padding: 1rem; border-left: 6px solid #10b981;">
          <i class="fas fa-quote-left" style="color: #10b981; opacity: 0.5; margin-right: 0.5rem;"></i>
          ${data.todAnswer || data.answer || "No answer provided"}
        </div>
      </div>`;
      
      if (data.htAnswer) {
        html += `<div style="margin-bottom: 1.5rem;">
          <h5 style="display: flex; align-items: center; gap: 0.5rem; color: #0a4e7a; margin-bottom: 0.5rem;">
            <i class="fas fa-reply" style="color: #0a66c2;"></i> HT Response:
          </h5>
          <div style="background: rgba(224,242,254,0.7); backdrop-filter: blur(8px); border-radius: 20px; padding: 1rem; border-left: 6px solid #0a66c2;">
            <i class="fas fa-quote-left" style="color: #0a66c2; opacity: 0.5; margin-right: 0.5rem;"></i>
            ${data.htAnswer}
          </div>
        </div>`;
      }
      
      html += `<div class="table-responsive"><table>
        <thead>
          <tr>
            <th rowspan="2">Class</th>
            <th colspan="2">Registered</th>
            <th colspan="2">Present</th>
            <th colspan="2">Absent</th>
            <th colspan="2">Sick</th>
            <th colspan="2">Permission</th>
            <th rowspan="2">Total Present</th>
          </tr>
          <tr>
            <th>B</th><th>G</th>
            <th>B</th><th>G</th>
            <th>B</th><th>G</th>
            <th>B</th><th>G</th>
            <th>B</th><th>G</th>
          </tr>
        </thead>
        <tbody>`;
      
      data.data.forEach(r => {
        let preTotal = (parseInt(r.preB) || 0) + (parseInt(r.preG) || 0);
        html += `
          <tr>
            <td><strong>${r.class}</strong></td>
            <td>${r.regB || 0}</td>
            <td>${r.regG || 0}</td>
            <td>${r.preB || 0}</td>
            <td>${r.preG || 0}</td>
            <td>${r.absB || 0}</td>
            <td>${r.absG || 0}</td>
            <td>${r.sickB || 0}</td>
            <td>${r.sickG || 0}</td>
            <td>${r.perB || 0}</td>
            <td>${r.perG || 0}</td>
            <td><strong>${preTotal}</strong></td>
          </tr>
        `;
      });
      
      html += `
        <tr class="totalRow">
          <td><strong>GRAND TOTAL</strong></td>
          <td><strong>${totalRegB}</strong></td>
          <td><strong>${totalRegG}</strong></td>
          <td><strong>${totalPreB}</strong></td>
          <td><strong>${totalPreG}</strong></td>
          <td><strong>${totalAbsB}</strong></td>
          <td><strong>${totalAbsG}</strong></td>
          <td><strong>${totalSickB}</strong></td>
          <td><strong>${totalSickG}</strong></td>
          <td><strong>${totalPerB}</strong></td>
          <td><strong>${totalPerG}</strong></td>
          <td><strong>${totalPreT}</strong></td>
        </tr>
      </tbody></table></div>`;
      
      html += `<div class="summary-card">
        <div class="summary-stat">
          <span class="summary-label">Total Students</span>
          <span class="summary-value">${totalRegT}</span>
        </div>
        <div class="summary-stat">
          <span class="summary-label">Present</span>
          <span class="summary-value">${totalPreT} <small>(${presentPercentage}%)</small></span>
        </div>
        <div class="summary-stat">
          <span class="summary-label">Absent</span>
          <span class="summary-value">${totalAbsT}</span>
        </div>
        <div class="summary-stat">
          <span class="summary-label">Sick</span>
          <span class="summary-value">${totalSickT}</span>
        </div>
        <div class="summary-stat">
          <span class="summary-label">Permission</span>
          <span class="summary-value">${totalPerT}</span>
        </div>
      </div>`;
    });
  }
  document.getElementById("activityTable").innerHTML = html;
};

// ---------- DOWNLOAD SELECTED DAY PDF ----------
window.downloadPDF = function() {
  if (!selectedDayData) { alert("Select a day first"); return; }
  
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  
  let totalRegB = 0, totalRegG = 0, totalRegT = 0;
  let totalPreB = 0, totalPreG = 0, totalPreT = 0;
  let totalAbsB = 0, totalAbsG = 0, totalAbsT = 0;
  let totalSickB = 0, totalSickG = 0, totalSickT = 0;
  let totalPerB = 0, totalPerG = 0, totalPerT = 0;
  
  selectedDayData.data.forEach(r => {
    totalRegB += parseInt(r.regB) || 0;
    totalRegG += parseInt(r.regG) || 0;
    totalPreB += parseInt(r.preB) || 0;
    totalPreG += parseInt(r.preG) || 0;
    totalAbsB += parseInt(r.absB) || 0;
    totalAbsG += parseInt(r.absG) || 0;
    totalSickB += parseInt(r.sickB) || 0;
    totalSickG += parseInt(r.sickG) || 0;
    totalPerB += parseInt(r.perB) || 0;
    totalPerG += parseInt(r.perG) || 0;
  });
  
  totalRegT = totalRegB + totalRegG;
  totalPreT = totalPreB + totalPreG;
  totalAbsT = totalAbsB + totalAbsG;
  totalSickT = totalSickB + totalSickG;
  totalPerT = totalPerB + totalPerG;
  
  let presentPercentage = 0;
  if (totalRegT > 0) {
    presentPercentage = Math.round((totalPreT / totalRegT) * 100);
  }
  
  pdf.setFontSize(18);
  pdf.text("TOD Attendance Report", 10, 10);
  pdf.setFontSize(14);
  pdf.text(`${selectedDayData.day} - ${selectedDayData.date}`, 10, 20);
  pdf.setFontSize(12);
  pdf.text(`TOD: ${selectedDayData.todName || 'N/A'}`, 10, 30);
  pdf.setFontSize(14);
  pdf.text(`Present Rate: ${presentPercentage}%`, 10, 40);
  
  pdf.setFontSize(12);
  pdf.text("TOD Answer:", 10, 55);
  pdf.setFontSize(10);
  const todAnswer = selectedDayData.todAnswer || selectedDayData.answer || "No answer provided";
  const splitAnswer = pdf.splitTextToSize(todAnswer, 180);
  pdf.text(splitAnswer, 15, 65);
  
  let y = 65 + (splitAnswer.length * 5);
  if (selectedDayData.htAnswer) {
    pdf.setFontSize(12);
    pdf.text("HT Response:", 10, y);
    pdf.setFontSize(10);
    const htResponse = selectedDayData.htAnswer;
    const splitResponse = pdf.splitTextToSize(htResponse, 180);
    pdf.text(splitResponse, 15, y + 10);
    y += 10 + (splitResponse.length * 5) + 10;
  } else {
    y += 15;
  }
  
  pdf.setFontSize(9);
  pdf.text("Class", 10, y);
  pdf.text("Reg B", 35, y);
  pdf.text("Reg G", 50, y);
  pdf.text("Pre B", 70, y);
  pdf.text("Pre G", 85, y);
  pdf.text("Abs B", 105, y);
  pdf.text("Abs G", 120, y);
  pdf.text("Sick B", 140, y);
  pdf.text("Sick G", 155, y);
  pdf.text("Perm B", 175, y);
  pdf.text("Perm G", 190, y);
  pdf.text("Total", 210, y);
  
  y += 7;
  
  selectedDayData.data.forEach(r => {
    let preTotal = (parseInt(r.preB) || 0) + (parseInt(r.preG) || 0);
    pdf.text(r.class, 10, y);
    pdf.text(String(r.regB || 0), 35, y);
    pdf.text(String(r.regG || 0), 50, y);
    pdf.text(String(r.preB || 0), 70, y);
    pdf.text(String(r.preG || 0), 85, y);
    pdf.text(String(r.absB || 0), 105, y);
    pdf.text(String(r.absG || 0), 120, y);
    pdf.text(String(r.sickB || 0), 140, y);
    pdf.text(String(r.sickG || 0), 155, y);
    pdf.text(String(r.perB || 0), 175, y);
    pdf.text(String(r.perG || 0), 190, y);
    pdf.text(String(preTotal), 210, y);
    y += 7;
  });
  
  pdf.setFontSize(10);
  pdf.text("GRAND TOTAL", 10, y);
  pdf.text(String(totalRegB), 35, y);
  pdf.text(String(totalRegG), 50, y);
  pdf.text(String(totalPreB), 70, y);
  pdf.text(String(totalPreG), 85, y);
  pdf.text(String(totalAbsB), 105, y);
  pdf.text(String(totalAbsG), 120, y);
  pdf.text(String(totalSickB), 140, y);
  pdf.text(String(totalSickG), 155, y);
  pdf.text(String(totalPerB), 175, y);
  pdf.text(String(totalPerG), 190, y);
  pdf.text(String(totalPreT), 210, y);
  
  y += 15;
  pdf.setFontSize(12);
  pdf.text(`SUMMARY:`, 10, y);
  y += 8;
  pdf.setFontSize(10);
  pdf.text(`Total Students: ${totalRegT}`, 15, y);
  y += 6;
  pdf.text(`Present: ${totalPreT} (${presentPercentage}%)`, 15, y);
  y += 6;
  pdf.text(`Absent: ${totalAbsT}`, 15, y);
  y += 6;
  pdf.text(`Sick: ${totalSickT}`, 15, y);
  y += 6;
  pdf.text(`Permission: ${totalPerT}`, 15, y);
  
  pdf.save(`TOD_Report_${selectedDayData.day}.pdf`);
};

// ---------- DOWNLOAD FULL WEEK PDF ----------
window.downloadWeekPDF = async function() {
  const user = auth.currentUser;
  const q = query(collection(db, "attendance"), where("todName", "==", isSuperView ? viewingUserData?.email : user.email));
  const snap = await getDocs(q);
  if (snap.empty) { alert("No attendance records found"); return; }
  
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  
  pdf.setFontSize(18);
  pdf.text("Weekly Attendance Report", 10, 10);
  pdf.setFontSize(12);
  pdf.text(`TOD: ${isSuperView ? viewingUserData?.email : user.email}`, 10, 20);
  
  let y = 35;
  
  snap.forEach((d) => {
    let data = d.data();
    
    if (y > 250) {
      pdf.addPage();
      y = 20;
    }
    
    let totalRegT = 0, totalPreT = 0;
    data.data.forEach(r => {
      totalRegT += (parseInt(r.regB) || 0) + (parseInt(r.regG) || 0);
      totalPreT += (parseInt(r.preB) || 0) + (parseInt(r.preG) || 0);
    });
    let percentage = totalRegT > 0 ? Math.round((totalPreT / totalRegT) * 100) : 0;
    
    pdf.setFontSize(11);
    pdf.text(`${data.day} - ${data.date} (Week ${data.weekNumber || '?'})`, 10, y);
    pdf.text(`Present: ${totalPreT}/${totalRegT} (${percentage}%)`, 100, y);
    y += 6;
    
    pdf.setFontSize(9);
    data.data.forEach(r => {
      let pre = (parseInt(r.preB) || 0) + (parseInt(r.preG) || 0);
      let abs = (parseInt(r.absB) || 0) + (parseInt(r.absG) || 0);
      pdf.text(`${r.class}: P:${pre} A:${abs}`, 15, y);
      y += 5;
    });
    y += 5;
  });
  
  pdf.save("TOD_Weekly_Report.pdf");
};

// ---------- DOWNLOAD CT REPORT ----------
window.downloadCTReport = function() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  
  pdf.setFontSize(18);
  pdf.text("Class Teacher Report", 10, 10);
  pdf.setFontSize(12);
  pdf.text(`${dayName} - ${todayISO}`, 10, 20);
  pdf.text(`Teacher: ${isSuperView ? viewingUserData?.name || viewingUserData?.email : currentUser?.email || 'N/A'}`, 10, 30);
  
  let y = 45;
  assignedClasses.forEach(cls => {
    const regB = document.getElementById(`regB_${cls}`)?.value || 0;
    const regG = document.getElementById(`regG_${cls}`)?.value || 0;
    const preB = document.getElementById(`preB_${cls}`)?.value || 0;
    const preG = document.getElementById(`preG_${cls}`)?.value || 0;
    
    const regTotal = parseInt(regB) + parseInt(regG);
    const preTotal = parseInt(preB) + parseInt(preG);
    
    pdf.text(`${cls}: Registered: ${regTotal} | Present: ${preTotal} (${regTotal>0 ? Math.round(preTotal/regTotal*100) : 0}%)`, 10, y);
    y += 7;
  });
  
  pdf.save(`CT_Report_${todayISO}.pdf`);
};

// ---------- DOWNLOAD TOD REPORT (New function for main dashboard) ----------
window.downloadTODReport = function() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  
  pdf.setFontSize(18);
  pdf.text("TOD Attendance Report", 10, 10);
  pdf.setFontSize(14);
  pdf.text(`${dayName} - ${todayISO}`, 10, 20);
  pdf.setFontSize(12);
  pdf.text(`Teacher: ${isSuperView ? viewingUserData?.name || viewingUserData?.email : currentUser?.email || 'N/A'}`, 10, 30);
  
  let y = 45;
  classes.forEach(cls => {
    const regB = document.getElementById(`regB_${cls}`)?.value || 0;
    const regG = document.getElementById(`regG_${cls}`)?.value || 0;
    const preB = document.getElementById(`preB_${cls}`)?.value || 0;
    const preG = document.getElementById(`preG_${cls}`)?.value || 0;
    
    const regTotal = parseInt(regB) + parseInt(regG);
    const preTotal = parseInt(preB) + parseInt(preG);
    
    pdf.text(`${cls}: Reg: ${regB}+${regG}=${regTotal} | Present: ${preB}+${preG}=${preTotal}`, 10, y);
    y += 7;
  });
  
  pdf.save(`TOD_Report_${todayISO}.pdf`);
};

// ---------- AUTO-SAVE INDICATOR ----------
function showAutoSaveIndicator(message) {
  const indicator = document.getElementById("autoSaveIndicator");
  if (indicator) {
    indicator.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
    setTimeout(() => {
      indicator.innerHTML = '<i class="fas fa-circle"></i> Auto-save ready';
    }, 2000);
  }
}

// ---------- LOAD CT ATTENDANCE ----------
async function loadCTAttendance() {
  await updateClassCountsFromStudents();
}

// ---------- LOGOUT FUNCTION ----------
async function logout() {
  try {
    await signOut(auth);
    alert("‚úÖ Logged out successfully");
    window.location.href = "index.html";
  } catch (error) {
    alert("Error logging out: " + error.message);
  }
}

// ---------- MAKE FUNCTIONS GLOBAL ----------
window.saveAttendance = saveAttendance;
window.showActivity = showActivity;
window.loadDay = loadDay;
window.downloadPDF = downloadPDF;
window.downloadWeekPDF = downloadWeekPDF;
window.downloadCTReport = downloadCTReport;
window.downloadTODReport = downloadTODReport;
window.saveAnswer = saveAnswer;
window.calcRow = calcRow;
window.calculateGrandTotals = calculateGrandTotals;
window.logout = logout;
window.switchTab = switchTab;
window.addStudent = addStudent;
window.setStudentStatus = setStudentStatus;
window.deleteStudent = deleteStudent;
window.loadFullHistory = loadFullHistory;
window.loadMonthHistory = loadMonthHistory;
window.viewHistoryDay = viewHistoryDay;
window.deleteHistoryDay = deleteHistoryDay;
window.deleteAllHistory = deleteAllHistory;
window.returnToOwnDashboard = returnToOwnDashboard;

// ---------- ATTACH LOGOUT BUTTONS ----------
document.getElementById("logoutBtn").addEventListener("click", logout);
document.getElementById("logoutBtnBottom").addEventListener("click", logout);
</script>

</body>
</html>
