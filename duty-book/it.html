<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<title>IT Dashboard · Multi-School Management</title>

<!-- Font Awesome 6 (free) for icons & brand -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<style>
  /* ---------- GLOBAL & VARIABLES ---------- */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  }

  body {
    background: linear-gradient(145deg, #f0f4fa 0%, #e9eef4 100%);
    min-height: 100vh;
    padding: clamp(1rem, 5vw, 2rem);
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    line-height: 1.5;
  }

  /* ---------- DECORATIVE RADIAL CIRCLES (fixed) ---------- */
  .bg-circle-1, .bg-circle-2 {
    position: fixed;
    width: 280px;
    height: 280px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(0,112,243,0.08) 0%, transparent 80%);
    pointer-events: none;
    z-index: 0;
  }
  .bg-circle-1 {
    top: 2%;
    left: 2%;
    width: clamp(200px, 30vw, 280px);
    height: clamp(200px, 30vw, 280px);
    background: radial-gradient(circle, rgba(0,112,243,0.08) 0%, transparent 75%);
  }
  .bg-circle-2 {
    bottom: 5%;
    right: 2%;
    width: clamp(240px, 35vw, 340px);
    height: clamp(240px, 35vw, 340px);
    background: radial-gradient(circle, rgba(0,180,210,0.07) 0%, transparent 80%);
  }

  /* ---------- MAIN CONTAINER (above circles) ---------- */
  .dashboard-container {
    max-width: 1400px;
    width: 100%;
    position: relative;
    z-index: 10;
    animation: fadeSlide 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  }

  /* ---------- GLASS CARD (reusable) ---------- */
  .glass-card {
    background: rgba(255,255,255,0.8);
    backdrop-filter: blur(16px) saturate(180%);
    -webkit-backdrop-filter: blur(16px) saturate(180%);
    border-radius: clamp(24px, 5vw, 32px);
    box-shadow: 0 20px 35px -10px rgba(0,20,40,0.15);
    border: 1px solid rgba(255,255,255,0.3);
    box-shadow: 0 0 0 1px rgba(255,255,255,0.5) inset, 0 20px 35px -10px rgba(0,20,40,0.15);
    padding: clamp(1.2rem, 4vw, 2rem);
    transition: box-shadow 0.25s ease, background 0.25s;
    margin-bottom: 1.8rem;
  }
  .glass-card:hover {
    background: rgba(255,255,255,0.95);
    box-shadow: 0 24px 42px -12px rgba(0,60,120,0.2), 0 0 0 1px rgba(255,255,255,0.7) inset;
  }

  /* ---------- FLUID TYPOGRAPHY / CLAMP ---------- */
  body, input, select, button, td, th, li, .badge, .info-note, #todayDate, h2 {
    font-size: clamp(0.8rem, 2vw, 0.95rem);
  }

  h2 {
    font-size: clamp(1.3rem, 4vw, 1.6rem);
    font-weight: 600;
    color: #0b2b4e;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  h3 {
    font-size: clamp(1.1rem, 3.5vw, 1.3rem);
    font-weight: 600;
    color: #1e4c6b;
    margin-bottom: 1.2rem;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .section-icon {
    font-size: clamp(1.4rem, 4vw, 1.6rem);
    color: #0a66c2;
    background: rgba(10,102,194,0.08);
    padding: 0.6rem;
    border-radius: 18px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  /* ---------- HEADER CARD (brand + role) ---------- */
  .header-card {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 2rem;
  }
  .brand {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .brand i {
    font-size: clamp(1.6rem, 5vw, 2rem);
    color: #0a66c2;
    filter: drop-shadow(0 4px 6px rgba(0,102,204,0.2));
  }
  .brand-text {
    background: linear-gradient(150deg, #0b2b4e, #1e4c6b);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    font-weight: 700;
    font-size: clamp(1.4rem, 5vw, 1.9rem);
    letter-spacing: -0.01em;
  }
  .role-badge {
    background: rgba(10,102,194,0.15);
    border-radius: 40px;
    color: #0a4e7a;
    padding: 0.5rem 1.5rem;
    font-weight: 600;
    font-size: 0.95rem;
    border: 1px solid rgba(255,255,255,0.3);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* ---------- SCHOOL SELECTOR ---------- */
  .school-selector {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
    padding: 1rem;
    background: rgba(255,255,255,0.5);
    border-radius: 40px;
    backdrop-filter: blur(8px);
    border: 1px solid rgba(10,102,194,0.2);
    flex-wrap: wrap;
  }
  
  .school-selector select {
    padding: 0.5rem 1rem;
    border-radius: 30px;
    border: 2px solid #0a66c2;
    background: white;
    font-size: 0.95rem;
    min-width: 250px;
    cursor: pointer;
  }
  
  .current-school-badge {
    background: #0a66c2;
    color: white;
    padding: 0.3rem 1rem;
    border-radius: 30px;
    font-size: 0.8rem;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
  }

  /* ---------- FORM INPUTS WITH ICONS ---------- */
  .input-icon-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    width: 100%;
  }
  .input-icon-wrapper i {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: #6b8ca3;
    font-size: 1rem;
    z-index: 2;
  }
  .input-icon-wrapper input,
  .input-icon-wrapper select,
  .input-icon-wrapper textarea {
    width: 100%;
    padding: 0.85rem 1rem 0.85rem 2.8rem;
    background: rgba(255,255,255,0.8);
    border: 1.5px solid rgba(200,215,225,0.7);
    border-radius: 20px;
    font-size: clamp(0.8rem, 2vw, 0.95rem);
    transition: all 0.2s;
    outline: none;
    color: #1e2f3e;
    appearance: none;
  }
  .input-icon-wrapper textarea {
    padding: 0.85rem 1rem 0.85rem 2.8rem;
    resize: vertical;
    min-height: 80px;
  }
  .input-icon-wrapper select {
    background: rgba(255,255,255,0.8) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b8ca3' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E") no-repeat;
    background-position: right 1rem center;
    background-size: 16px;
    padding-right: 2.5rem;
  }
  .input-icon-wrapper input:focus,
  .input-icon-wrapper select:focus,
  .input-icon-wrapper textarea:focus {
    border-color: #0a66c2;
    background: white;
    box-shadow: 0 6px 14px rgba(10,102,194,0.08);
  }

  /* ---------- BUTTON VARIANTS ---------- */
  button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.6rem;
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 40px;
    padding: 0.7rem 1.5rem;
    font-weight: 600;
    font-size: clamp(0.8rem, 2vw, 0.95rem);
    transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    cursor: pointer;
    background: transparent;
    color: inherit;
    white-space: nowrap;
  }
  button i {
    font-size: 0.95rem;
  }
  .btn-primary {
    background: #0a66c2;
    color: white;
    box-shadow: 0 8px 16px -6px rgba(10,102,194,0.25);
  }
  .btn-primary:hover {
    background: #004a8f;
    scale: 1.02;
    border-color: rgba(255,255,255,0.5);
  }
  .btn-success {
    background: #10b981;
    color: white;
  }
  .btn-success:hover {
    background: #059669;
    scale: 1.02;
  }
  .btn-danger {
    background: #ef4444;
    color: white;
  }
  .btn-danger:hover {
    background: #dc2626;
    scale: 1.02;
  }
  .btn-outline {
    background: transparent;
    border: 1.5px solid #0a66c2;
    color: #0a66c2;
  }
  .btn-outline:hover {
    background: #0a66c2;
    color: white;
    scale: 1.02;
  }
  .btn-small {
    padding: 0.4rem 1rem;
    font-size: 0.8rem;
  }
  .btn-school {
    background: #8b5cf6;
    color: white;
  }
  .btn-school:hover {
    background: #7c3aed;
    scale: 1.02;
  }
  @media (max-width: 768px) {
    button { width: 100%; justify-content: center; }
  }

  /* ---------- GRID & FLEX ---------- */
  .grid-auto {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(100%, 250px), 1fr));
    gap: 1.2rem;
    align-items: end;
  }
  .flex-wrap {
    display: flex;
    flex-wrap: wrap;
    gap: 1.2rem;
    align-items: center;
  }

  /* ---------- TABLE STYLES ---------- */
  .table-responsive {
    overflow-x: auto;
    margin-top: 1.5rem;
    border-radius: 20px;
    width: 100%;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: rgba(255,255,255,0.4);
    backdrop-filter: blur(4px);
    border-radius: 20px;
    border-style: hidden;
    box-shadow: 0 0 0 1px rgba(10,102,194,0.1);
  }
  th {
    background: #0a66c2;
    color: white;
    padding: 0.9rem 0.5rem;
    font-weight: 600;
    text-align: center;
    font-size: 0.85rem;
    letter-spacing: 0.3px;
  }
  th:first-child { border-radius: 16px 0 0 0; }
  th:last-child { border-radius: 0 16px 0 0; }
  td {
    padding: 0.8rem 0.5rem;
    border-bottom: 1px solid rgba(10,102,194,0.1);
    background: transparent;
    text-align: center;
    vertical-align: middle;
  }
  tbody tr:hover {
    background: rgba(10,102,194,0.02);
  }
  tfoot tr {
    background: #0a66c2;
    color: white;
    font-weight: 700;
  }
  tfoot td, tfoot th {
    border-top: 2px solid rgba(255,255,255,0.3);
    background: #0a66c2;
    color: white;
  }

  /* ---------- INPUT STYLES INSIDE TABLE ---------- */
  td input {
    width: 60px;
    padding: 0.5rem;
    border-radius: 16px;
    border: 1.5px solid rgba(200,215,225,0.7);
    background: rgba(255,255,255,0.9);
    text-align: center;
    font-size: 0.9rem;
    transition: all 0.2s;
    font-weight: 500;
  }
  td input:focus {
    border-color: #0a66c2;
    box-shadow: 0 0 0 3px rgba(10,102,194,0.1);
    outline: none;
    background: white;
  }
  
  td input[readonly] {
    background: rgba(230, 240, 250, 0.5);
    color: #2c5a73;
    font-weight: 600;
    border-color: rgba(10,102,194,0.2);
    cursor: not-allowed;
  }

  /* ---------- SCHOOL CARDS ---------- */
  .school-cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
  }
  .school-card {
    background: white;
    border-radius: 24px;
    padding: 1.5rem;
    border-left: 6px solid #0a66c2;
    transition: all 0.2s;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    position: relative;
    overflow: hidden;
  }
  .school-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(10,102,194,0.15);
  }
  .school-card::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 100px;
    height: 100px;
    background: linear-gradient(135deg, transparent 50%, rgba(10,102,194,0.03) 50%);
    border-radius: 0 0 0 100px;
  }
  .school-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }
  .school-name {
    font-size: 1.3rem;
    font-weight: 700;
    color: #1e293b;
  }
  .school-code {
    background: rgba(10,102,194,0.1);
    color: #0a66c2;
    padding: 0.2rem 0.8rem;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: 600;
  }
  .school-location {
    color: #6b8ca3;
    font-size: 0.9rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .school-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin: 1rem 0;
  }
  .stat-pill {
    background: rgba(10,102,194,0.08);
    color: #0a66c2;
    padding: 0.4rem 1rem;
    border-radius: 30px;
    font-size: 0.8rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }
  .school-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1.2rem;
    border-top: 1px solid rgba(10,102,194,0.1);
    padding-top: 1.2rem;
  }

  /* ---------- BADGES & INFO ---------- */
  .badge {
    background: rgba(10,102,194,0.1);
    border-radius: 30px;
    padding: 0.3rem 1rem;
    font-size: 0.8rem;
    color: #0a4e7a;
    display: inline-block;
    border: 1px solid rgba(255,255,255,0.2);
  }
  .badge-success {
    background: rgba(16,185,129,0.15);
    color: #059669;
  }
  .badge-warning {
    background: rgba(245,158,11,0.15);
    color: #d97706;
  }
  .badge-purple {
    background: rgba(139,92,246,0.15);
    color: #7c3aed;
  }
  .info-note {
    background: rgba(10,102,194,0.04);
    border-radius: 16px;
    padding: 1rem;
    border: 1px dashed rgba(10,102,194,0.2);
    display: flex;
    align-items: center;
    gap: 0.8rem;
    color: #2c5a73;
    margin: 1.2rem 0;
  }
  .empty-state {
    text-align: center;
    padding: 2rem;
    color: #6b8ca3;
    background: rgba(255,255,255,0.5);
    border-radius: 24px;
    font-style: italic;
    backdrop-filter: blur(6px);
    border: 1px solid rgba(255,255,255,0.2);
  }

  /* ---------- ANIMATIONS ---------- */
  @keyframes fadeSlide {
    0% { opacity: 0; transform: translateY(12px); }
    100% { opacity: 1; transform: translateY(0); }
  }
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.8; }
    100% { opacity: 1; }
  }
  #logoutBtn i { transition: transform 0.2s; }
  #logoutBtn:hover i { transform: translateX(3px); }

  /* ---------- CUSTOM DATE DISPLAY ---------- */
  #todayDate {
    font-weight: 600;
    color: #1e4c6b;
    background: rgba(255,255,255,0.4);
    padding: 0.3rem 1.2rem;
    border-radius: 40px;
    display: inline-block;
    backdrop-filter: blur(4px);
  }

  hr {
    margin: 2rem 0;
    border: none;
    border-top: 1px solid rgba(10,102,194,0.2);
  }

  /* ---------- QUESTION TEXTAREAS ---------- */
  .question-section {
    margin-bottom: 1.5rem;
  }
  
  .question-header {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    margin-bottom: 0.5rem;
  }
  
  .question-header i {
    color: #0a66c2;
    font-size: 1.2rem;
  }
  
  .question-header span {
    font-weight: 600;
    color: #1e4c6b;
  }
  
  textarea {
    width: 100%;
    padding: 1rem;
    border-radius: 20px;
    border: 1.5px solid rgba(200,215,225,0.7);
    background: rgba(255,255,255,0.8);
    font-size: 0.95rem;
    transition: all 0.2s;
    margin-bottom: 1rem;
    font-family: 'Inter', sans-serif;
  }
  textarea:focus {
    border-color: #0a66c2;
    background: white;
    box-shadow: 0 6px 14px rgba(10,102,194,0.08);
    outline: none;
  }

  /* ---------- CLASS CHECKBOX GROUP ---------- */
  .class-checkbox-group {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 0.8rem;
    margin: 1rem 0;
    padding: 1rem;
    background: rgba(255,255,255,0.5);
    border-radius: 20px;
    border: 1px solid rgba(10,102,194,0.1);
  }
  .class-checkbox-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    background: white;
    border-radius: 12px;
    border: 1px solid rgba(10,102,194,0.1);
  }
  .class-checkbox-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: #0a66c2;
    cursor: pointer;
  }
  .class-checkbox-item label {
    font-weight: 500;
    color: #1e4c6b;
    cursor: pointer;
    flex: 1;
  }

  /* ---------- SELECTED CLASSES DISPLAY ---------- */
  .selected-classes {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin: 1rem 0;
    min-height: 40px;
  }
  .class-tag {
    background: #0a66c2;
    color: white;
    padding: 0.3rem 1rem;
    border-radius: 30px;
    font-size: 0.8rem;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    animation: fadeIn 0.3s ease;
  }
  .class-tag i {
    cursor: pointer;
    opacity: 0.8;
    transition: opacity 0.2s;
  }
  .class-tag i:hover {
    opacity: 1;
  }

  /* ---------- EDIT MODE INDICATOR ---------- */
  .edit-mode-indicator {
    background: #f59e0b;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 40px;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    margin-left: 1rem;
    animation: pulse 2s infinite;
  }

  /* ---------- INFO MESSAGE ---------- */
  .info-message {
    background: rgba(10,102,194,0.05);
    border-radius: 16px;
    padding: 0.8rem 1.2rem;
    margin-top: 1rem;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    color: #0a4e7a;
    display: flex;
    align-items: center;
    gap: 0.8rem;
    border-left: 4px solid #0a66c2;
  }

  /* ---------- MIGRATION SECTION ---------- */
  .migration-section {
    background: rgba(245,158,11,0.1);
    border: 2px solid rgba(245,158,11,0.3);
    border-radius: 24px;
    padding: 1.5rem;
    margin: 1.5rem 0;
  }
  .migration-title {
    color: #d97706;
    font-weight: 700;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
</style>
</head>

<body>
<!-- Decorative background circles -->
<div class="bg-circle-1"></div>
<div class="bg-circle-2"></div>

<div class="dashboard-container">
  <!-- HEADER CARD (brand + role) -->
  <div class="glass-card header-card">
    <div class="brand">
      <i class="fas fa-chart-pie"></i>
      <span class="brand-text">IT Dashboard</span>
    </div>
    <div class="role-badge">
      <i class="fas fa-user-shield"></i> IT Admin
      <span class="badge" style="margin-left: 0.5rem;">Multi-School Manager</span>
    </div>
  </div>

  <!-- DATE HEADER -->
  <h2 style="display: flex; align-items: center; gap: 1rem;">
    <i class="fas fa-calendar-alt" style="color: #0a66c2;"></i> 
    System Configuration - <span id="todayDate"></span>
  </h2>

  <!-- SCHOOL SELECTOR (for managing multiple schools) -->
  <div class="glass-card">
    <div class="school-selector">
      <i class="fas fa-school" style="color: #0a66c2; font-size: 1.2rem;"></i>
      <span style="font-weight: 600;">Current School:</span>
      <select id="schoolSelector" onchange="switchSchool()">
        <option value="">Loading schools...</option>
      </select>
      <span id="currentSchoolBadge" class="current-school-badge">
        <i class="fas fa-check-circle"></i> Select a school to begin
      </span>
    </div>
  </div>

  <!-- ================= CLASS REGISTRATION TABLE ================= -->
  <div class="glass-card">
    <h3><span class="section-icon"><i class="fas fa-chalkboard-teacher"></i></span> Class Registration (Prep 1 - Class 7)</h3>
    
    <div class="info-message">
      <i class="fas fa-info-circle"></i>
      <span><strong>School-specific:</strong> These registration numbers apply only to the currently selected school.</span>
    </div>
    
    <div class="table-responsive">
      <table id="attendanceTable">
        <thead>
          <tr>
            <th>Class</th>
            <th>Reg B</th><th>Reg G</th><th>Reg T</th>
            <th>Pre B</th><th>Pre G</th><th>Pre T</th>
            <th>Abs B</th><th>Abs G</th><th>Abs T</th>
            <th>Perm</th>
            <th>Sick</th>
          </tr>
        </thead>
        <tbody id="attendanceBody"></tbody>
        <tfoot>
          <tr>
            <td>GRAND TOTAL</td>
            <td id="gRegB">0</td>
            <td id="gRegG">0</td>
            <td id="gRegT">0</td>
            <td id="gPreB">0</td>
            <td id="gPreG">0</td>
            <td id="gPreT">0</td>
            <td id="gAbsB">0</td>
            <td id="gAbsG">0</td>
            <td id="gAbsT">0</td>
            <td id="gPerm">0</td>
            <td id="gSick">0</td>
          </tr>
        </tfoot>
      </table>
    </div>
    
    <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem;">
      <button class="btn-success" onclick="saveRegistration()">
        <i class="fas fa-save"></i> Save Registration Numbers
      </button>
      <button class="btn-primary" onclick="loadRegistration()">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
    </div>
  </div>

  <!-- ================= SCHOOL MANAGEMENT ================= -->
  <div class="glass-card">
    <h3><span class="section-icon"><i class="fas fa-school"></i></span> School Management</h3>
    
    <div class="grid-auto">
      <div class="input-icon-wrapper">
        <i class="fas fa-school"></i>
        <input type="text" id="newSchoolName" placeholder="School Name">
      </div>
      <div class="input-icon-wrapper">
        <i class="fas fa-map-marker-alt"></i>
        <input type="text" id="newSchoolLocation" placeholder="Location (e.g., City, Country)">
      </div>
      <div class="input-icon-wrapper">
        <i class="fas fa-globe"></i>
        <input type="text" id="newSchoolCode" placeholder="School Code (optional)">
      </div>
    </div>
    
    <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
      <button class="btn-school" onclick="createSchool()">
        <i class="fas fa-plus-circle"></i> Create New School
      </button>
      <button class="btn-outline" onclick="loadSchools()">
        <i class="fas fa-sync-alt"></i> Refresh Schools
      </button>
    </div>

    <!-- Schools Grid -->
    <div id="schoolsContainer" class="school-cards"></div>
  </div>

  <!-- ================= MIGRATION SECTION (for existing data) ================= -->
  <div class="migration-section">
    <div class="migration-title">
      <i class="fas fa-exclamation-triangle"></i>
      <span>Data Migration Tool</span>
    </div>
    <p style="margin-bottom: 1rem; color: #92400e;">
      If you had existing data before multi-school support, use this tool to assign it to a school.
    </p>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
      <select id="migrationSchoolSelect" style="padding: 0.5rem; border-radius: 20px; border: 2px solid #d97706; min-width: 250px;">
        <option value="">Select target school...</option>
      </select>
      <button class="btn-warning" onclick="migrateExistingData()">
        <i class="fas fa-database"></i> Migrate All Data to Selected School
      </button>
      <button class="btn-outline" onclick="checkUnassignedData()">
        <i class="fas fa-search"></i> Check for Unassigned Data
      </button>
    </div>
    <div id="migrationStatus" style="margin-top: 1rem; font-size: 0.9rem;"></div>
  </div>

  <!-- ================= USER MANAGEMENT WITH SCHOOL ASSIGNMENT ================= -->
  <div class="glass-card">
    <h3><span class="section-icon"><i class="fas fa-user-plus"></i></span> Create / Edit User</h3>
    
    <div class="grid-auto">
      <div class="input-icon-wrapper">
        <i class="fas fa-user"></i>
        <input type="text" id="newName" placeholder="Full Name">
      </div>
      <div class="input-icon-wrapper">
        <i class="fas fa-envelope"></i>
        <input type="email" id="newEmail" placeholder="Email">
      </div>
      <div class="input-icon-wrapper">
        <i class="fas fa-lock"></i>
        <input type="password" id="newPass" placeholder="Password (new users only)">
      </div>
      <div class="input-icon-wrapper">
        <i class="fas fa-briefcase"></i>
        <select id="newRole" onchange="toggleClassSelection()">
          <option value="TOD">TOD (Teacher On Duty)</option>
          <option value="CT">CT (Class Teacher)</option>
          <option value="HT">HT (Head Teacher)</option>
          <option value="SHC">SHC</option>
          <option value="SUPER">SUPER (Super User)</option>
          <option value="IT">IT</option>
        </select>
      </div>
    </div>

    <!-- School Selection for User -->
    <div style="margin-top: 1rem; margin-bottom: 1rem;">
      <label style="font-weight: 600; color: #0a4e7a;">Assign to School:</label>
      <select id="userSchoolSelect" style="width: 100%; padding: 0.85rem; border-radius: 20px; border: 1.5px solid rgba(200,215,225,0.7); margin-top: 0.5rem;">
        <option value="">Select a school...</option>
      </select>
    </div>

    <!-- Class Selection for CT and TOD -->
    <div id="classSelectionSection" style="display: none; margin-top: 1.5rem;">
      <h4 style="color: #0a4e7a; margin-bottom: 1rem;">
        <i class="fas fa-chalkboard"></i> Assign Classes (select multiple)
      </h4>
      <div class="info-note" style="margin-bottom: 1rem;">
        <i class="fas fa-info-circle"></i> CTs and TODs can be assigned to multiple classes.
      </div>
      
      <!-- Class Checkboxes -->
      <div id="classCheckboxes" class="class-checkbox-group"></div>
      
      <!-- Selected Classes Display -->
      <div id="selectedClassesDisplay" class="selected-classes"></div>
    </div>
    
    <div style="display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap;">
      <button class="btn-success" onclick="createUser()">
        <i class="fas fa-check-circle"></i> Create User
      </button>
      <button class="btn-primary" onclick="clearUserForm()">
        <i class="fas fa-undo"></i> Clear Form
      </button>
      <div id="editModeIndicator" class="edit-mode-indicator" style="display: none;">
        <i class="fas fa-pen"></i> Editing Mode
      </div>
    </div>

    <h3 style="margin-top: 2rem;"><span class="section-icon"><i class="fas fa-users"></i></span> All Users</h3>
    
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>School</th>
            <th>Classes</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="usersBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ================= DAILY QUESTIONS ================= -->
  <div class="glass-card">
    <h3><span class="section-icon"><i class="fas fa-clipboard-list"></i></span> Daily Questions</h3>
    
    <div class="question-section">
      <div class="question-header">
        <i class="fas fa-user-tie"></i>
        <span>TOD Questions</span>
      </div>
      <textarea id="todQ" rows="3" placeholder="Enter TOD questions for today..."></textarea>
    </div>
    
    <div class="question-section">
      <div class="question-header">
        <i class="fas fa-user-shield"></i>
        <span>HT / SHC Questions</span>
      </div>
      <textarea id="htQ" rows="3" placeholder="Enter HT questions for today..."></textarea>
    </div>
    
    <div style="display: flex; justify-content: flex-end;">
      <button class="btn-primary" onclick="saveQuestions()">
        <i class="fas fa-save"></i> Save Questions
      </button>
    </div>
  </div>

  <!-- ========== LOGOUT BUTTON ========== -->
  <div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
    <button id="logoutBtn" class="btn-outline" style="border-width: 1.5px; padding: 0.7rem 2.2rem;">
      <i class="fas fa-sign-out-alt"></i> Logout
    </button>
  </div>
</div>

<!-- ================= SCRIPT ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc, getDocs,
  collection, deleteDoc, updateDoc, query, where,
  writeBatch
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
  getAuth, onAuthStateChanged,
  createUserWithEmailAndPassword,
  signOut, signInWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// ========== FIREBASE CONFIG ==========
const firebaseConfig = {
  apiKey: "AIzaSyBYOXnAQQWQNI9rFu0ZwMjNkMEdJH7SxxA",
  authDomain: "teacher-on-duty-system.firebaseapp.com",
  projectId: "teacher-on-duty-system",
  storageBucket: "teacher-on-duty-system.firebasestorage.app",
  messagingSenderId: "723640168531",
  appId: "1:723640168531:web:a52f5dac1f5502460016a6"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// ========== DATE ==========
document.getElementById("todayDate").innerText = 
  new Date().toLocaleDateString("en-US", { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });

/* ---------- GLOBAL VARIABLES ---------- */
let currentUserId = null;
let editingUserId = null;
let currentSchoolId = null;
let allSchools = [];
let classes = [
  "Prep 1", "Prep 2",
  "Class 1", "Class 2", "Class 3",
  "Class 4", "Class 5", "Class 6", "Class 7"
];

/* ---------- ROLE PROTECTION (IT only) ---------- */
onAuthStateChanged(auth, async (user) => {
  if (!user) { 
    window.location = "index.html"; 
    return;
  }
  
  currentUserId = user.uid;
  
  const snap = await getDoc(doc(db, "users", user.uid));
  if (!snap.exists() || snap.data().role !== "IT") {
    alert("Access Denied: IT admin only");
    window.location = "index.html";
  }
  
  // Load schools first
  await loadSchools();
  await loadUsers();
  await loadRegistration();
  await loadQuestions();
  initClassCheckboxes();
  
  // If there are schools, select the first one by default
  if (allSchools.length > 0) {
    currentSchoolId = allSchools[0].id;
    document.getElementById('schoolSelector').value = currentSchoolId;
    updateCurrentSchoolBadge();
    await loadSchoolSpecificData();
  }
});

/* ---------- SCHOOL MANAGEMENT ---------- */
async function loadSchools() {
  const schoolsSnap = await getDocs(collection(db, "schools"));
  allSchools = [];
  
  schoolsSnap.forEach(doc => {
    allSchools.push({ id: doc.id, ...doc.data() });
  });
  
  // Update school selector
  const selector = document.getElementById('schoolSelector');
  const userSchoolSelect = document.getElementById('userSchoolSelect');
  const migrationSelect = document.getElementById('migrationSchoolSelect');
  
  selector.innerHTML = '<option value="">Select a school...</option>';
  userSchoolSelect.innerHTML = '<option value="">Select a school...</option>';
  migrationSelect.innerHTML = '<option value="">Select target school...</option>';
  
  allSchools.forEach(school => {
    const option = document.createElement('option');
    option.value = school.id;
    option.textContent = school.name;
    selector.appendChild(option.cloneNode(true));
    userSchoolSelect.appendChild(option.cloneNode(true));
    migrationSelect.appendChild(option.cloneNode(true));
  });
  
  // Render school cards
  renderSchoolCards();
}

async function renderSchoolCards() {
  const container = document.getElementById('schoolsContainer');
  container.innerHTML = '';
  
  if (allSchools.length === 0) {
    container.innerHTML = '<div class="empty-state">No schools created yet. Create your first school above.</div>';
    return;
  }
  
  for (const school of allSchools) {
    // Get stats for this school
    const usersQuery = query(collection(db, "users"), where("schoolId", "==", school.id));
    const usersSnap = await getDocs(usersQuery);
    
    const todCount = usersSnap.docs.filter(d => d.data().role === 'TOD').length;
    const ctCount = usersSnap.docs.filter(d => d.data().role === 'CT' || d.data().isAlsoCT).length;
    const htCount = usersSnap.docs.filter(d => d.data().role === 'HT').length;
    const superCount = usersSnap.docs.filter(d => d.data().role === 'SUPER').length;
    
    const card = document.createElement('div');
    card.className = 'school-card';
    card.innerHTML = `
      <div class="school-header">
        <span class="school-name">${school.name}</span>
        ${school.code ? `<span class="school-code">${school.code}</span>` : ''}
      </div>
      <div class="school-location">
        <i class="fas fa-map-marker-alt"></i> ${school.location || 'No location set'}
      </div>
      <div class="school-stats">
        <span class="stat-pill"><i class="fas fa-users"></i> ${usersSnap.size} Users</span>
        <span class="stat-pill"><i class="fas fa-user-tie"></i> ${todCount} TOD</span>
        <span class="stat-pill"><i class="fas fa-chalkboard-teacher"></i> ${ctCount} CT</span>
        <span class="stat-pill"><i class="fas fa-user-shield"></i> ${htCount} HT</span>
        ${superCount > 0 ? `<span class="stat-pill"><i class="fas fa-crown"></i> ${superCount} SUPER</span>` : ''}
      </div>
      <div class="school-actions">
        <button class="btn-small btn-primary" onclick="selectSchool('${school.id}')">
          <i class="fas fa-check"></i> Select
        </button>
        <button class="btn-small btn-outline" onclick="editSchool('${school.id}')">
          <i class="fas fa-edit"></i> Edit
        </button>
        <button class="btn-small btn-danger" onclick="deleteSchool('${school.id}')">
          <i class="fas fa-trash"></i> Delete
        </button>
      </div>
    `;
    container.appendChild(card);
  }
}

window.createSchool = async function() {
  const name = document.getElementById('newSchoolName').value.trim();
  const location = document.getElementById('newSchoolLocation').value.trim();
  const code = document.getElementById('newSchoolCode').value.trim();
  
  if (!name) { alert("School name is required"); return; }
  
  try {
    const schoolRef = doc(collection(db, "schools"));
    await setDoc(schoolRef, {
      name,
      location: location || '',
      code: code || '',
      createdAt: new Date(),
      createdBy: auth.currentUser?.email
    });
    
    alert("✅ School created successfully!");
    document.getElementById('newSchoolName').value = '';
    document.getElementById('newSchoolLocation').value = '';
    document.getElementById('newSchoolCode').value = '';
    
    await loadSchools();
  } catch (error) {
    alert("Error creating school: " + error.message);
  }
};

window.editSchool = async function(schoolId) {
  const school = allSchools.find(s => s.id === schoolId);
  if (!school) return;
  
  const newName = prompt("Edit School Name:", school.name);
  if (newName === null) return;
  
  const newLocation = prompt("Edit Location:", school.location || '');
  if (newLocation === null) return;
  
  const newCode = prompt("Edit School Code:", school.code || '');
  if (newCode === null) return;
  
  try {
    await updateDoc(doc(db, "schools", schoolId), {
      name: newName,
      location: newLocation,
      code: newCode,
      updatedAt: new Date(),
      updatedBy: auth.currentUser?.email
    });
    
    alert("✅ School updated successfully!");
    await loadSchools();
  } catch (error) {
    alert("Error updating school: " + error.message);
  }
};

window.deleteSchool = async function(schoolId) {
  // First check if there are users in this school
  const usersQuery = query(collection(db, "users"), where("schoolId", "==", schoolId));
  const usersSnap = await getDocs(usersQuery);
  
  if (usersSnap.size > 0) {
    alert(`❌ Cannot delete school with ${usersSnap.size} users. Please reassign or delete users first.`);
    return;
  }
  
  // Check if there are attendance records
  const attendanceQuery = query(collection(db, "attendance"), where("schoolId", "==", schoolId));
  const attendanceSnap = await getDocs(attendanceQuery);
  
  if (attendanceSnap.size > 0) {
    alert(`❌ Cannot delete school with ${attendanceSnap.size} attendance records. Please migrate data first.`);
    return;
  }
  
  // Check if there are students
  const studentsQuery = query(collection(db, "students"), where("schoolId", "==", schoolId));
  const studentsSnap = await getDocs(studentsQuery);
  
  if (studentsSnap.size > 0) {
    alert(`❌ Cannot delete school with ${studentsSnap.size} students. Please reassign or delete students first.`);
    return;
  }
  
  const school = allSchools.find(s => s.id === schoolId);
  if (!confirm(`Are you sure you want to delete school "${school.name}"? This cannot be undone.`)) return;
  
  try {
    await deleteDoc(doc(db, "schools", schoolId));
    alert("✅ School deleted successfully!");
    await loadSchools();
    
    // If this was the current school, clear selection
    if (currentSchoolId === schoolId) {
      currentSchoolId = null;
      document.getElementById('schoolSelector').value = '';
      updateCurrentSchoolBadge();
    }
  } catch (error) {
    alert("Error deleting school: " + error.message);
  }
};

window.selectSchool = function(schoolId) {
  currentSchoolId = schoolId;
  document.getElementById('schoolSelector').value = schoolId;
  updateCurrentSchoolBadge();
  loadSchoolSpecificData();
};

window.switchSchool = function() {
  const selector = document.getElementById('schoolSelector');
  currentSchoolId = selector.value;
  if (currentSchoolId) {
    updateCurrentSchoolBadge();
    loadSchoolSpecificData();
  } else {
    updateCurrentSchoolBadge();
  }
};

function updateCurrentSchoolBadge() {
  const school = allSchools.find(s => s.id === currentSchoolId);
  const badge = document.getElementById('currentSchoolBadge');
  if (school) {
    badge.innerHTML = `<i class="fas fa-check-circle"></i> Working on: <strong>${school.name}</strong>`;
  } else {
    badge.innerHTML = `<i class="fas fa-exclamation-circle"></i> No school selected`;
  }
}

async function loadSchoolSpecificData() {
  if (!currentSchoolId) return;
  await loadRegistration();
  await loadUsers();
}

/* ---------- MIGRATION TOOLS ---------- */
window.checkUnassignedData = async function() {
  const statusDiv = document.getElementById('migrationStatus');
  statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
  
  // Check users without schoolId
  const usersQuery = query(collection(db, "users"), where("schoolId", "==", null));
  const usersSnap = await getDocs(usersQuery);
  
  // Check attendance without schoolId
  const attendanceQuery = query(collection(db, "attendance"), where("schoolId", "==", null));
  const attendanceSnap = await getDocs(attendanceQuery);
  
  // Check students without schoolId
  const studentsQuery = query(collection(db, "students"), where("schoolId", "==", null));
  const studentsSnap = await getDocs(studentsQuery);
  
  statusDiv.innerHTML = `
    <div style="background: white; padding: 1rem; border-radius: 16px;">
      <p><strong>Unassigned Data Found:</strong></p>
      <ul style="margin-left: 2rem;">
        <li>Users without school: ${usersSnap.size}</li>
        <li>Attendance records without school: ${attendanceSnap.size}</li>
        <li>Students without school: ${studentsSnap.size}</li>
      </ul>
    </div>
  `;
};

window.migrateExistingData = async function() {
  const targetSchoolId = document.getElementById('migrationSchoolSelect').value;
  if (!targetSchoolId) {
    alert("Please select a target school");
    return;
  }
  
  if (!confirm("This will migrate ALL unassigned data to the selected school. Continue?")) return;
  
  const statusDiv = document.getElementById('migrationStatus');
  statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Migrating data...';
  
  try {
    const batch = writeBatch(db);
    let count = 0;
    
    // Migrate users
    const usersQuery = query(collection(db, "users"), where("schoolId", "==", null));
    const usersSnap = await getDocs(usersQuery);
    usersSnap.forEach(doc => {
      batch.update(doc.ref, { schoolId: targetSchoolId });
      count++;
    });
    
    // Migrate attendance
    const attendanceQuery = query(collection(db, "attendance"), where("schoolId", "==", null));
    const attendanceSnap = await getDocs(attendanceQuery);
    attendanceSnap.forEach(doc => {
      batch.update(doc.ref, { schoolId: targetSchoolId });
      count++;
    });
    
    // Migrate students
    const studentsQuery = query(collection(db, "students"), where("schoolId", "==", null));
    const studentsSnap = await getDocs(studentsQuery);
    studentsSnap.forEach(doc => {
      batch.update(doc.ref, { schoolId: targetSchoolId });
      count++;
    });
    
    await batch.commit();
    
    statusDiv.innerHTML = `<div style="background: #d1fae5; color: #065f46; padding: 1rem; border-radius: 16px;">
      ✅ Migration complete! Updated ${count} records.
    </div>`;
    
    await loadUsers();
  } catch (error) {
    statusDiv.innerHTML = `<div style="background: #fee2e2; color: #991b1b; padding: 1rem; border-radius: 16px;">
      ❌ Error: ${error.message}
    </div>`;
  }
};

/* ---------- INIT CLASS CHECKBOXES ---------- */
function initClassCheckboxes() {
  const container = document.getElementById("classCheckboxes");
  container.innerHTML = "";
  
  classes.forEach(cls => {
    const div = document.createElement("div");
    div.className = "class-checkbox-item";
    div.innerHTML = `
      <input type="checkbox" id="cls_${cls.replace(/\s/g, '_')}" value="${cls}" onchange="updateSelectedClasses()">
      <label for="cls_${cls.replace(/\s/g, '_')}">${cls}</label>
    `;
    container.appendChild(div);
  });
}

/* ---------- TOGGLE CLASS SELECTION BASED ON ROLE ---------- */
window.toggleClassSelection = function() {
  const role = document.getElementById("newRole").value;
  const section = document.getElementById("classSelectionSection");
  
  if (role === "CT" || role === "TOD") {
    section.style.display = "block";
  } else {
    section.style.display = "none";
    clearClassSelections();
  }
};

/* ---------- CLEAR CLASS SELECTIONS ---------- */
function clearClassSelections() {
  document.querySelectorAll('#classCheckboxes input[type="checkbox"]').forEach(cb => {
    cb.checked = false;
  });
  document.getElementById("selectedClassesDisplay").innerHTML = "";
}

/* ---------- UPDATE SELECTED CLASSES DISPLAY ---------- */
window.updateSelectedClasses = function() {
  const selected = [];
  document.querySelectorAll('#classCheckboxes input[type="checkbox"]:checked').forEach(cb => {
    selected.push(cb.value);
  });
  
  const display = document.getElementById("selectedClassesDisplay");
  display.innerHTML = "";
  
  selected.forEach(cls => {
    const tag = document.createElement("span");
    tag.className = "class-tag";
    tag.innerHTML = `${cls} <i class="fas fa-times" onclick="removeClass('${cls}')"></i>`;
    display.appendChild(tag);
  });
};

/* ---------- REMOVE CLASS FROM SELECTION ---------- */
window.removeClass = function(cls) {
  const cb = document.getElementById(`cls_${cls.replace(/\s/g, '_')}`);
  if (cb) {
    cb.checked = false;
    updateSelectedClasses();
  }
};

/* ---------- CREATE REGISTRATION TABLE ---------- */
const tbody = document.getElementById("attendanceBody");

function createTable() {
  tbody.innerHTML = "";
  
  classes.forEach(c => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><strong>${c}</strong></td>
      <td><input type="number" class="regB" value="0" min="0" style="width:60px; padding:0.5rem; border-radius:12px; text-align:center;"></td>
      <td><input type="number" class="regG" value="0" min="0" style="width:60px; padding:0.5rem; border-radius:12px; text-align:center;"></td>
      <td><input type="number" class="regT" value="0" readonly style="width:60px; padding:0.5rem; border-radius:12px; text-align:center; background:rgba(200,215,225,0.2);"></td>
      <td><input type="number" class="preB" value="0" readonly style="width:60px; padding:0.5rem; border-radius:12px; text-align:center;"></td>
      <td><input type="number" class="preG" value="0" readonly style="width:60px; padding:0.5rem; border-radius:12px; text-align:center;"></td>
      <td><input type="number" class="preT" value="0" readonly style="width:60px; padding:0.5rem; border-radius:12px; text-align:center;"></td>
      <td><input type="number" class="absB" value="0" readonly style="width:60px; padding:0.5rem; border-radius:12px; text-align:center;"></td>
      <td><input type="number" class="absG" value="0" readonly style="width:60px; padding:0.5rem; border-radius:12px; text-align:center;"></td>
      <td><input type="number" class="absT" value="0" readonly style="width:60px; padding:0.5rem; border-radius:12px; text-align:center;"></td>
      <td><input type="number" class="perm" value="0" readonly style="width:60px; padding:0.5rem; border-radius:12px; text-align:center;"></td>
      <td><input type="number" class="sick" value="0" readonly style="width:60px; padding:0.5rem; border-radius:12px; text-align:center;"></td>
    `;
    tbody.appendChild(tr);
  });
  
  document.querySelectorAll('.regB, .regG').forEach(input => {
    input.addEventListener('input', function() {
      const row = this.closest('tr');
      const regB = +row.querySelector('.regB').value || 0;
      const regG = +row.querySelector('.regG').value || 0;
      row.querySelector('.regT').value = regB + regG;
      calculateTotals();
    });
  });
}

createTable();

/* ---------- CALCULATE TOTALS ---------- */
function calculateTotals() {
  let gRegB = 0, gRegG = 0, gRegT = 0;
  let gPreB = 0, gPreG = 0, gPreT = 0;
  let gAbsB = 0, gAbsG = 0, gAbsT = 0;
  let gPerm = 0, gSick = 0;

  [...tbody.rows].forEach(r => {
    const regB = +r.querySelector(".regB").value || 0;
    const regG = +r.querySelector(".regG").value || 0;
    const preB = +r.querySelector(".preB").value || 0;
    const preG = +r.querySelector(".preG").value || 0;
    const absB = +r.querySelector(".absB").value || 0;
    const absG = +r.querySelector(".absG").value || 0;
    const perm = +r.querySelector(".perm").value || 0;
    const sick = +r.querySelector(".sick").value || 0;

    r.querySelector(".regT").value = regB + regG;

    gRegB += regB; gRegG += regG;
    gPreB += preB; gPreG += preG;
    gAbsB += absB; gAbsG += absG;
    gPerm += perm; gSick += sick;
  });

  gRegT = gRegB + gRegG;
  gPreT = gPreB + gPreG;
  gAbsT = gAbsB + gAbsG;

  document.getElementById("gRegB").innerText = gRegB;
  document.getElementById("gRegG").innerText = gRegG;
  document.getElementById("gRegT").innerText = gRegT;
  document.getElementById("gPreB").innerText = gPreB;
  document.getElementById("gPreG").innerText = gPreG;
  document.getElementById("gPreT").innerText = gPreT;
  document.getElementById("gAbsB").innerText = gAbsB;
  document.getElementById("gAbsG").innerText = gAbsG;
  document.getElementById("gAbsT").innerText = gAbsT;
  document.getElementById("gPerm").innerText = gPerm;
  document.getElementById("gSick").innerText = gSick;
}

/* ---------- SAVE REGISTRATION (school-specific) ---------- */
window.saveRegistration = async () => {
  if (!currentSchoolId) {
    alert("Please select a school first");
    return;
  }
  
  const registrationData = [];
  [...tbody.rows].forEach(r => {
    registrationData.push({
      class: r.cells[0].innerText,
      regB: +r.querySelector(".regB").value || 0,
      regG: +r.querySelector(".regG").value || 0
    });
  });
  
  await setDoc(doc(db, "schools", currentSchoolId, "config", "classRegistration"), { 
    classes: registrationData,
    lastUpdated: new Date(),
    updatedBy: auth.currentUser?.email || 'IT Admin'
  });
  
  alert("✅ Registration numbers saved for this school!");
};

/* ---------- LOAD REGISTRATION (school-specific) ---------- */
window.loadRegistration = async () => {
  if (!currentSchoolId) return;
  
  const snap = await getDoc(doc(db, "schools", currentSchoolId, "config", "classRegistration"));
  if (snap.exists()) {
    const data = snap.data().classes;
    if (data && data.length) {
      [...tbody.rows].forEach((r, index) => {
        if (data[index]) {
          r.querySelector(".regB").value = data[index].regB || 0;
          r.querySelector(".regG").value = data[index].regG || 0;
        }
      });
      calculateTotals();
    }
  }
  
  // Also load today's attendance for display
  const today = new Date().toISOString().split('T')[0];
  const attendanceDocId = `${today}_${currentSchoolId}`;
  const attendanceSnap = await getDoc(doc(db, "attendance", attendanceDocId));
  
  if (attendanceSnap.exists()) {
    const data = attendanceSnap.data().data;
    if (data && data.length) {
      [...tbody.rows].forEach((r, index) => {
        if (data[index]) {
          r.querySelector(".preB").value = data[index].preB || 0;
          r.querySelector(".preG").value = data[index].preG || 0;
          r.querySelector(".absB").value = data[index].absB || 0;
          r.querySelector(".absG").value = data[index].absG || 0;
          r.querySelector(".perm").value = data[index].perm || 0;
          r.querySelector(".sick").value = data[index].sick || 0;
        }
      });
      calculateTotals();
    }
  }
};

/* ---------- SAVE QUESTIONS ---------- */
window.saveQuestions = async () => {
  const todQuestion = document.getElementById("todQ").value;
  const htQuestion = document.getElementById("htQ").value;
  
  await setDoc(doc(db, "questions", "daily"), {
    tod: todQuestion,
    ht: htQuestion,
    updatedAt: new Date(),
    updatedBy: auth.currentUser?.email || 'IT Admin'
  });
  
  alert("✅ Questions saved!");
};

/* ---------- LOAD QUESTIONS ---------- */
async function loadQuestions() {
  const qSnap = await getDoc(doc(db, "questions", "daily"));
  if (qSnap.exists()) {
    document.getElementById("todQ").value = qSnap.data().tod || "";
    document.getElementById("htQ").value = qSnap.data().ht || "";
  }
}

/* ---------- LOAD USERS (school-specific) ---------- */
async function loadUsers() {
  let q;
  if (currentSchoolId) {
    q = query(collection(db, "users"), where("schoolId", "==", currentSchoolId));
  } else {
    q = collection(db, "users");
  }
  
  const snap = await getDocs(q);
  const body = document.getElementById("usersBody");
  body.innerHTML = "";
  
  // Also load all schools for reference
  const schoolsSnap = await getDocs(collection(db, "schools"));
  const schools = {};
  schoolsSnap.forEach(doc => {
    schools[doc.id] = doc.data().name;
  });
  
  for (const docu of snap.docs) {
    const u = docu.data();
    const isCurrentUser = (docu.id === currentUserId);
    
    let classesHtml = '';
    if (u.assignedClasses && u.assignedClasses.length > 0) {
      classesHtml = u.assignedClasses.map(cls => 
        `<span class="badge badge-success" style="margin: 2px;">${cls}</span>`
      ).join(' ');
    } else {
      classesHtml = '<span class="badge" style="opacity: 0.5;">None</span>';
    }
    
    let roleBadgeClass = '';
    if (u.role === 'CT') roleBadgeClass = 'badge-success';
    else if (u.role === 'TOD') roleBadgeClass = 'badge-warning';
    else if (u.role === 'HT') roleBadgeClass = 'badge-info';
    else if (u.role === 'SUPER') roleBadgeClass = 'badge-purple';
    
    const schoolName = u.schoolId ? (schools[u.schoolId] || 'Unknown') : 'Not assigned';
    
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><strong>${u.name || ''}</strong> ${isCurrentUser ? '<span class="badge" style="background: #0a66c2; color: white;">You</span>' : ''}</td>
      <td>${u.email || ''}</td>
      <td><span class="badge ${roleBadgeClass}">${u.role || ''}</span> ${u.isAlsoCT ? '<span class="badge badge-success" style="margin-left: 2px;">Also CT</span>' : ''}</td>
      <td><span class="badge" style="background: #8b5cf6; color: white;">${schoolName}</span></td>
      <td>${classesHtml}</td>
      <td>
        <button class="btn-small btn-primary" style="margin: 0 2px;" onclick="editUser('${docu.id}')">
          <i class="fas fa-edit"></i> Edit
        </button>
        <button class="btn-small btn-danger" style="margin: 0 2px;" onclick="deleteUser('${docu.id}', ${isCurrentUser})">
          <i class="fas fa-trash"></i> Delete
        </button>
      </td>
    `;
    body.appendChild(tr);
  }
}

/* ---------- CLEAR USER FORM ---------- */
window.clearUserForm = function() {
  editingUserId = null;
  document.getElementById("newName").value = "";
  document.getElementById("newEmail").value = "";
  document.getElementById("newPass").value = "";
  document.getElementById("newRole").value = "TOD";
  document.getElementById("userSchoolSelect").value = currentSchoolId || "";
  document.getElementById("editModeIndicator").style.display = "none";
  clearClassSelections();
  toggleClassSelection();
};

/* ---------- EDIT USER ---------- */
window.editUser = async (id) => {
  const userDoc = await getDoc(doc(db, "users", id));
  if (!userDoc.exists()) return;
  
  const userData = userDoc.data();
  editingUserId = id;
  
  document.getElementById("newName").value = userData.name || '';
  document.getElementById("newEmail").value = userData.email || '';
  document.getElementById("newPass").value = '';
  document.getElementById("newRole").value = userData.role || 'TOD';
  document.getElementById("userSchoolSelect").value = userData.schoolId || '';
  document.getElementById("editModeIndicator").style.display = "inline-flex";
  
  toggleClassSelection();
  
  clearClassSelections();
  if (userData.assignedClasses && userData.assignedClasses.length > 0) {
    userData.assignedClasses.forEach(cls => {
      const cb = document.getElementById(`cls_${cls.replace(/\s/g, '_')}`);
      if (cb) cb.checked = true;
    });
    updateSelectedClasses();
  }
};

/* ---------- CREATE/UPDATE USER ---------- */
window.createUser = async () => {
  const name = document.getElementById("newName").value.trim();
  const email = document.getElementById("newEmail").value.trim();
  const pass = document.getElementById("newPass").value;
  const role = document.getElementById("newRole").value;
  const schoolId = document.getElementById("userSchoolSelect").value;
  
  if (!schoolId) {
    alert("Please select a school for this user");
    return;
  }
  
  const assignedClasses = [];
  document.querySelectorAll('#classCheckboxes input[type="checkbox"]:checked').forEach(cb => {
    assignedClasses.push(cb.value);
  });
  
  if (!name || !email) return alert("Name and Email are required");
  
  const admin = auth.currentUser;
  const adminEmail = admin.email;
  
  try {
    if (editingUserId) {
      const userData = {
        name,
        email,
        role,
        schoolId,
        updatedAt: new Date(),
        updatedBy: adminEmail
      };
      
      if (role === "CT" || role === "TOD") {
        userData.assignedClasses = assignedClasses;
        userData.isAlsoCT = (role === "TOD" && assignedClasses.length > 0);
      } else {
        userData.assignedClasses = [];
        userData.isAlsoCT = false;
      }
      
      await updateDoc(doc(db, "users", editingUserId), userData);
      alert("✅ User Updated Successfully");
    } else {
      if (!pass) return alert("Password required for new users");
      
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      
      const userData = {
        name,
        email,
        role,
        schoolId,
        createdAt: new Date(),
        createdBy: adminEmail
      };
      
      if (role === "CT" || role === "TOD") {
        userData.assignedClasses = assignedClasses;
        userData.isAlsoCT = (role === "TOD" && assignedClasses.length > 0);
      } else {
        userData.assignedClasses = [];
        userData.isAlsoCT = false;
      }
      
      await setDoc(doc(db, "users", cred.user.uid), userData);
      
      await signOut(auth);
      const adminPass = prompt("Re-enter IT admin password to continue");
      if (!adminPass) {
        window.location = "index.html";
        return;
      }
      await signInWithEmailAndPassword(auth, adminEmail, adminPass);
      
      alert("✅ User Created Successfully");
    }
    
    clearUserForm();
    await loadUsers();
  } catch (e) {
    alert("Error: " + e.message);
  }
};

/* ---------- DELETE USER ---------- */
window.deleteUser = async (id, isCurrentUser) => {
  if (isCurrentUser) {
    alert("❌ You cannot delete your own account!");
    return;
  }
  
  if (confirm("Delete this user?")) {
    try {
      await deleteDoc(doc(db, "users", id));
      alert("✅ User deleted successfully");
      await loadUsers();
    } catch (error) {
      alert("Error deleting user: " + error.message);
    }
  }
};

/* ---------- LOGOUT ---------- */
document.getElementById("logoutBtn").onclick = async () => {
  await signOut(auth);
  window.location = "index.html";
};

// Make functions globally available
window.calculateTotals = calculateTotals;
window.saveRegistration = saveRegistration;
window.loadRegistration = loadRegistration;
window.saveQuestions = saveQuestions;
window.createUser = createUser;
window.editUser = editUser;
window.deleteUser = deleteUser;
window.clearUserForm = clearUserForm;
window.toggleClassSelection = toggleClassSelection;
window.updateSelectedClasses = updateSelectedClasses;
window.removeClass = removeClass;
window.loadSchools = loadSchools;
window.createSchool = createSchool;
window.editSchool = editSchool;
window.deleteSchool = deleteSchool;
window.selectSchool = selectSchool;
window.switchSchool = switchSchool;
window.checkUnassignedData = checkUnassignedData;
window.migrateExistingData = migrateExistingData;
</script>

</body>
</html>
